<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scoped spawn and reliable cancellation - wg-async</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> 👋🏽 Welcome</a></li><li class="chapter-item "><a href="../../CHARTER.html"><strong aria-hidden="true">2.</strong> 📜 Charter</a></li><li class="chapter-item "><a href="../../meetings.html"><strong aria-hidden="true">3.</strong> 🤝 Meetings</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.1.</strong> 🔍 Triage</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">4.</strong> 🔮 The vision</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">4.1.</strong> ❓How to vision</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/owners.html"><strong aria-hidden="true">4.1.1.</strong> Owning a goal or initiative</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/stakeholders.html"><strong aria-hidden="true">4.1.2.</strong> Being a stakeholder</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/evaluations.html"><strong aria-hidden="true">4.1.3.</strong> Writing an evaluation</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">4.1.4.</strong> Authoring "Status quo" stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">4.1.5.</strong> Authoring "Shiny future" stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">4.1.6.</strong> Commenting on stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">4.1.7.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/how_it_feels.html"><strong aria-hidden="true">4.2.</strong> 🥰 How using async Rust ought to feel</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">4.3.</strong> 🙋‍♀️ Cast of characters</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">4.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">4.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">4.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">4.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">4.4.</strong> ⚡ Projects</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">4.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">4.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">4.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">4.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">4.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">4.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item "><a href="../../vision/status_quo.html"><strong aria-hidden="true">4.5.</strong> 😱 Status quo</a></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">4.6.</strong> ✨ Shiny future</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/users_manual.html"><strong aria-hidden="true">4.6.1.</strong> 📚 User's manual of the future</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/roadmap.html"><strong aria-hidden="true">4.7.</strong> 📅 Roadmap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/async_fn.html"><strong aria-hidden="true">4.7.1.</strong> Async fn everywhere</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/async_fn/boxable.html"><strong aria-hidden="true">4.7.1.1.</strong> Boxable async fn</a></li><li class="chapter-item "><a href="../../vision/roadmap/async_fn/async_main_and_tests.html"><strong aria-hidden="true">4.7.1.2.</strong> Async main and tests</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/roadmap/scopes.html" class="active"><strong aria-hidden="true">4.7.2.</strong> Scoped spawn and reliable cancellation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/scopes/capability.html"><strong aria-hidden="true">4.7.2.1.</strong> Capability</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/scopes/capability/variant_async_trait.html"><strong aria-hidden="true">4.7.2.1.1.</strong> Variant: Async trait</a></li><li class="chapter-item "><a href="../../vision/roadmap/scopes/capability/variant_leak.html"><strong aria-hidden="true">4.7.2.1.2.</strong> Variant: Leak trait</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/scopes/scope_api.html"><strong aria-hidden="true">4.7.2.2.</strong> Scope API</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/async_iter.html"><strong aria-hidden="true">4.7.3.</strong> Async iteration</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/async_iter/traits.html"><strong aria-hidden="true">4.7.3.1.</strong> Traits</a></li><li class="chapter-item "><a href="../../vision/roadmap/async_iter/generators.html"><strong aria-hidden="true">4.7.3.2.</strong> Generators</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/portable.html"><strong aria-hidden="true">4.7.4.</strong> Portable and interoperable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/portable/read_write.html"><strong aria-hidden="true">4.7.4.1.</strong> Read/write traits</a></li><li class="chapter-item "><a href="../../vision/roadmap/portable/timers.html"><strong aria-hidden="true">4.7.4.2.</strong> Timers</a></li><li class="chapter-item "><a href="../../vision/roadmap/portable/spawn.html"><strong aria-hidden="true">4.7.4.3.</strong> Spawn</a></li><li class="chapter-item "><a href="../../vision/roadmap/portable/runtime.html"><strong aria-hidden="true">4.7.4.4.</strong> Runtime</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/polish.html"><strong aria-hidden="true">4.7.5.</strong> Polish</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/polish/lint_must_not_suspend.html"><strong aria-hidden="true">4.7.5.1.</strong> must_not_suspend lint</a></li><li class="chapter-item "><a href="../../vision/roadmap/polish/lint_blocking_fns.html"><strong aria-hidden="true">4.7.5.2.</strong> Lint blocking fns</a></li><li class="chapter-item "><a href="../../vision/roadmap/polish/lint_large_copies.html"><strong aria-hidden="true">4.7.5.3.</strong> Lint large copies</a></li><li class="chapter-item "><a href="../../vision/roadmap/polish/error_messages.html"><strong aria-hidden="true">4.7.5.4.</strong> Error messages for the most confusing scenarios</a></li><li class="chapter-item "><a href="../../vision/roadmap/polish/stacktraces.html"><strong aria-hidden="true">4.7.5.5.</strong> Stacktraces</a></li><li class="chapter-item "><a href="../../vision/roadmap/polish/precise_generator_captures.html"><strong aria-hidden="true">4.7.5.6.</strong> Precise Generator Captures</a></li><li class="chapter-item "><a href="../../vision/roadmap/polish/sync_and_async.html"><strong aria-hidden="true">4.7.5.7.</strong> Sync and async behave the same</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/tooling.html"><strong aria-hidden="true">4.7.6.</strong> Tooling</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/tooling/crashdump.html"><strong aria-hidden="true">4.7.6.1.</strong> Crashdump</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/testing.html"><strong aria-hidden="true">4.7.7.</strong> Testing</a></li><li class="chapter-item "><a href="../../vision/roadmap/documentation.html"><strong aria-hidden="true">4.7.8.</strong> Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/documentation/async_book.html"><strong aria-hidden="true">4.7.8.1.</strong> Async book</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap/threadsafe_portability.html"><strong aria-hidden="true">4.7.9.</strong> Threadsafe portability</a></li><li class="chapter-item "><a href="../../vision/roadmap/async_overloading.html"><strong aria-hidden="true">4.7.10.</strong> Async overloading</a></li></ol></li><li class="chapter-item "><a href="../../vision/unresolved_questions.html"><strong aria-hidden="true">4.8.</strong> ❓ Major unresolved questions or controversies</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/unresolved_questions/default_runtime.html"><strong aria-hidden="true">4.8.1.</strong> Default runtime?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/async_fn.html"><strong aria-hidden="true">4.8.2.</strong> How to represent the AsyncFn traits?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/cancellation.html"><strong aria-hidden="true">4.8.3.</strong> How best to integrate voluntary cancellation?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/portable_without_generics.html"><strong aria-hidden="true">4.8.4.</strong> Extend stdlib to permit portable async without generics?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/await_or_not.html"><strong aria-hidden="true">4.8.5.</strong> To await or not to await?</a></li></ol></li><li class="chapter-item "><a href="../../vision/submitted_stories.html"><strong aria-hidden="true">4.9.</strong> 💝 Appendix: Submitted stories</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo.html"><strong aria-hidden="true">4.9.1.</strong> 😱 Status quo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/template.html"><strong aria-hidden="true">4.9.1.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_builds_a_task_scheduler.html"><strong aria-hidden="true">4.9.1.2.</strong> Alan builds a task scheduler</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_creates_a_hanging_alarm.html"><strong aria-hidden="true">4.9.1.3.</strong> Alan creates a hanging alarm</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">4.9.1.4.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">4.9.1.5.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">4.9.1.6.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">4.9.1.7.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">4.9.1.8.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_misses_c_sharp_async.html"><strong aria-hidden="true">4.9.1.9.</strong> Alan misses C# async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">4.9.1.10.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">4.9.1.11.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">4.9.1.12.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">4.9.1.13.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">4.9.1.14.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">4.9.1.15.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">4.9.1.16.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_tries_processing_some_files.html"><strong aria-hidden="true">4.9.1.17.</strong> Alan tries tries processing some files</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html"><strong aria-hidden="true">4.9.1.18.</strong> Alan wants a prefetch iterator</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">4.9.1.19.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">4.9.1.20.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer.html"><strong aria-hidden="true">4.9.1.21.</strong> Alan extends an AWS service</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">4.9.1.21.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">4.9.1.21.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">4.9.1.21.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">4.9.1.21.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">4.9.1.21.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">4.9.1.21.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">4.9.1.21.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html"><strong aria-hidden="true">4.9.1.21.8.</strong> Solving a deadlock</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">4.9.1.21.9.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">4.9.1.21.10.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">4.9.1.21.11.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/using_the_debugger.html"><strong aria-hidden="true">4.9.1.21.12.</strong> Using the debugger</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">4.9.1.21.13.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">4.9.1.21.14.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/getting_ready_to_deploy.html"><strong aria-hidden="true">4.9.1.21.15.</strong> Getting ready to deply</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">4.9.1.21.16.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">4.9.1.22.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html"><strong aria-hidden="true">4.9.1.23.</strong> Barbara awants single threaded optimizations</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_battles_buffered_streams.html"><strong aria-hidden="true">4.9.1.24.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html"><strong aria-hidden="true">4.9.1.25.</strong> Barbara begets backpressure and benchmarks async_trait</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">4.9.1.26.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">4.9.1.27.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">4.9.1.28.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">4.9.1.29.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">4.9.1.30.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">4.9.1.31.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">4.9.1.32.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">4.9.1.33.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_polls_a_mutex.html"><strong aria-hidden="true">4.9.1.34.</strong> Barbara polls a Mutex</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">4.9.1.35.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_tries_unix_socket.html"><strong aria-hidden="true">4.9.1.36.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">4.9.1.37.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">4.9.1.38.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">4.9.1.39.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wishes_for_easy_runtime_switch.html"><strong aria-hidden="true">4.9.1.40.</strong> Barbara wishes for an easy runtim switch</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">4.9.1.41.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_debugs_a_crash_dump.html"><strong aria-hidden="true">4.9.1.42.</strong> Grace debugs a crash dump</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">4.9.1.43.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">4.9.1.44.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">4.9.1.45.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_wants_a_zero_copy_api.html"><strong aria-hidden="true">4.9.1.46.</strong> Grace wants a zero copy API</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">4.9.1.47.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">4.9.1.48.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">4.9.1.49.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">4.9.1.50.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future.html"><strong aria-hidden="true">4.9.2.</strong> ✨ Shiny future</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/template.html"><strong aria-hidden="true">4.9.2.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">4.9.2.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">4.9.2.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">4.9.2.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">4.9.2.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">4.9.2.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">4.9.2.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">4.9.2.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">4.9.2.9.</strong> Barbara wants async tracing</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/grace_debugs_a_crash_dump_again.html"><strong aria-hidden="true">4.9.2.10.</strong> Grace debugs a crash dump again</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">5.</strong> 🔬 Design docs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">5.1.</strong> ⚠️ Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">5.2.</strong> ☔ Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">5.3.</strong> ⚡ Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">5.4.</strong> 📝 AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">5.5.</strong> 🧬 Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">5.6.</strong> 🔒 Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">5.7.</strong> 📺 Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">5.8.</strong> 📦 Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">5.9.</strong> 🤝 Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">5.10.</strong> 🤷‍♀️ Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">5.11.</strong> 🚰 Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">5.12.</strong> 🎇 Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">5.13.</strong> 🗑️ Async drop</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">5.13.1.</strong> ♻️ Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">5.14.</strong> ⏳ Completion-based futures</a></li><li class="chapter-item "><a href="../../design_docs/async_stack_traces.html"><strong aria-hidden="true">5.15.</strong> 🥞 Async Stack Traces</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">6.</strong> 💬 Conversations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">6.1.</strong> 🐦 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">7.</strong> ❤️ Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async/tree/master/src/vision/roadmap/scopes.md?mode&#x3D;edit" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="scopes"><a class="header" href="#scopes">Scopes</a></h1>
<h2 id="impact"><a class="header" href="#impact">Impact</a></h2>
<ul>
<li>Able to spawn parallel tasks or blocking work that accesses borrowed data</li>
<li>Easily create expressive scheduler patterns that make use of borrowed data using high-level combinators and APIs</li>
<li>When data is no longer needed, able to cancel work and have it reliably and promptly terminate, including any subtasks or other bits of work it may have created</li>
<li>Cancellation does not leave work &quot;half-finished&quot;, but reliably cleans up program state</li>
<li>Able to use DMA, io-uring, etc to write directly into output buffers, and to recover in the case of cancellation</li>
</ul>
<h2 id="requires"><a class="header" href="#requires">Requires</a></h2>
<ul>
<li><a href="./scopes/capability.html">capability</a></li>
<li><a href="./scopes/api.html">APIs</a></li>
</ul>
<h2 id="design-notes"><a class="header" href="#design-notes">Design notes</a></h2>
<p>Async functions are commonly written with borrowed references as arguments:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_something(db: &amp;Db) { ... }
<span class="boring">}</span></code></pre></pre>
<p>but important utilities like <code>spawn</code> and <code>spawn_blocking</code> require <code>'static</code> tasks. Building on non-cancelable traits, we can implement a &quot;scope&quot; API that allows one to introduce an async scope. This scope API should permit one to spawn tasks into a scope, but have various kinds of scopes (e.g., synchronous execution, parallel execution, and so forth). It should ultimately reside in the standard library and hook into different runtimes for scheduling. This will take some experimentation!</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn foo(db: &amp;Database) {
    let result = std::async_thread::scope(|s| {
        let job1 = s.spawn(async || {
            async_thing(db)
        });
        let job2 = s.spawn_blocking(|| {
            sync_thing(db)
        });

        (job1.await, job2.await)
    }).await;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="side-stepping-the-nested-await-problem"><a class="header" href="#side-stepping-the-nested-await-problem">Side-stepping the nested await problem</a></h3>
<p>One goal of scopes is to avoid the &quot;nested await&quot; problem, as described in <a href="https://rust-lang.github.io/wg-async/vision/status_quo/barbara_battles_buffered_streams.html">Barbara battles buffered streams (BBBS)</a>. The idea is like this: the standard combinators which run work &quot;in the background&quot; and which give access to intermediate results from that work should schedule that work into a scope.<sup class="footnote-reference"><a href="#hard">1</a></sup> This would typically be done by using an &quot;interior iterator&quot; pattern, but it could also be done by taking a scope parameter. Some examples from today's APIs are <code>FuturesUnordered</code> and <code>Stream::buffered</code>.</p>
<div class="footnote-definition" id="hard"><sup class="footnote-definition-label">1</sup>
<p>This is not a hard rule. But invoking poll manually is best regarded as a risky thing to be managed with care -- not only because of the formal safety guarantees, but because of the possibility for &quot;nested await&quot;-style failures.</p>
</div>
<p>In the case of <a href="https://rust-lang.github.io/wg-async/vision/status_quo/barbara_battles_buffered_streams.html">BBBS</a>, the problem arises because of <code>buffered</code>, which spawns off concurrent work to process multiple connections. Under this system, the implementation of <code>buffered</code> would create an internal scope for spawn its tasks into that scope, side-stepping the problem. One could imagine also offering a variant of <code>buffered</code> like <code>buffered_in</code> that takes a scope parameter, permitting the user to choose the scope of those spawned tasks:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_work(database: &amp;Database) {
    std::async_thread::scope(|s| {
        let work = do_select(database, FIND_WORK_QUERY).await?;
        std::async_iter::from_iter(work)
            .map(|item| do_select(database, work_from_item(item)))
            .buffered_in(5, scope)
            .for_each(|work_item| process_work_item(database, work_item))
            .await;
    }).await;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="concurrency-without-scopes-join-select-race-and-friends"><a class="header" href="#concurrency-without-scopes-join-select-race-and-friends">Concurrency without scopes: Join, select, race, and friends</a></h3>
<p>It is possible to introduce concurrency in ways that both (a) do not require scopes and (b) avoid the &quot;nested await&quot; problem. Any combinator which takes multiple <code>Async</code> instances and polls them to completion (or cancels them) before it itself returns is ok. This includes:</p>
<ul>
<li><code>join</code>, because the <code>join(a, b)</code> doesn't complete until both <code>a</code> and <code>b</code> have completed;</li>
<li><code>select</code>, because selecting will cancel the alternatives that are not chosen;</li>
<li><code>race</code>, which is a variant of select.</li>
</ul>
<p>This is important because embedded systems often avoid allocators, and the scope API implicitly requires allocation (one can spawn an unbounded number of tasks).</p>
<h3 id="cancellation"><a class="header" href="#cancellation">Cancellation</a></h3>
<p>In today's Rust, any async function can be synchronously cancelled at any await point: the code simply stops executing, and destructors are run for any extant variables. This leads to a lot of bugs. (TODO: link to stories)</p>
<p>Under systems like <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0304-structured-concurrency.md">Swift's proposed structured concurrency model</a>, or with APIs like <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken?view=net-5.0">.NET's CancellationToken</a>, cancellation is &quot;voluntary&quot;. What this means is that when a task is cancelled, a flag is set; the task can query this flag but is not otherwise affected. Under structured concurrency systems, this flag is propagated to all chidren (and transitively to their children).</p>
<p>Voluntary cancellation is a requirement for <a href="./scoped.html">scoped access</a>. If there are parallel tasks executing within a scope, and the scope itself is canceled, those parallel tasks must be joined and halted before the memory for the scope can be freed.</p>
<p>One downside of such a system is that cancellation <em>may not</em> take effect. We can make it more likely to work by integrating the cancellation flag into the standard library methods, similar to how tokio encourages <a href="https://tokio.rs/blog/2020-04-preemption">&quot;voluntary preemption&quot;</a>. This means that file reads and things will start to report errors (<code>Err(TaskCanceled)</code>) once the task has been canceled. This has the advantage that it exercises existing error paths and permits recovery.</p>
<h3 id="cancellation-and-select"><a class="header" href="#cancellation-and-select">Cancellation and <code>select</code></a></h3>
<p>The <code>select</code> macro chooses from N futures and returns the first one that matches. Today, the others are immediately canceled. This behavior doesn't play especially well with voluntary cancellation. There are a few options here:</p>
<ul>
<li>We could make <code>select</code> signal cancellation for each of the things it is selecting over and then wait for them to finish.</li>
<li>We could also make <code>select</code> continue to take <code>Future</code> (not <code>Async</code>) values, which effectively makes <code>Future</code> a &quot;cancel-safe&quot; trait (or perhaps we introduce a <code>CancelSafe</code> marker trait that extends <code>Async</code>).
<ul>
<li>This would mean that typical <code>async fn</code> could not be given to select, though we might allow people to mark <code>async fn</code> as &quot;cancel-safe&quot;, in which case they would implement <code>Future</code>. They would also not have access to ordinary async fn, though.
<ul>
<li>Effectively, the current <code>Future</code> trait becomes the &quot;cancel-safe&quot; form of <code>Async</code>. This is a bit odd, since it has other distinctions, like using <code>Pin</code>, so it might be preferable to use a 'marker trait'.</li>
</ul>
</li>
<li>Of course, users could spawn a task that calls the function and give the handle to select.</li>
</ul>
</li>
</ul>
<h2 id="frequently-asked-questions"><a class="header" href="#frequently-asked-questions">Frequently asked questions</a></h2>
<h3 id="could-there-be-a-convenient-way-to-access-the-current-scope"><a class="header" href="#could-there-be-a-convenient-way-to-access-the-current-scope">Could there be a convenient way to access the current scope?</a></h3>
<p>If we wanted to integrate the idea of scopes more deeply, we could have some way to get access to the current scope and reference its lifetime. Lots of unknowns to work out here, though. For example, suppose you have a function that creates a scope and invokes a closure within. Do we have a way to indicate to the closure that <code>'scope</code> in that closure may be different?</p>
<p>It starts to feel like simply passing &quot;scope&quot; values may be simpler, and perhaps we need a way to automate the threading of state instead. Another advantage of passing a <code>scope</code> explicitly is that it is clear when parallel tasks may be launched.</p>
<h3 id="how-does-cancellation-work-in-other-settings"><a class="header" href="#how-does-cancellation-work-in-other-settings">How does cancellation work in other settings?</a></h3>
<p>Many other languages use a shard flag to observe when cancellation has been requested.</p>
<p>In some languages, there is also an immediate callback that is invoked when cancellation is requested which permits you to take immediate action. <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0304-structured-concurrency.md#cancellation-handlers">Swift proposal E0304</a>, for example, includes &quot;cancellation handlers&quot; that are run immediately.</p>
<ul>
<li><a href="https://kotlinlang.org/docs/cancellation-and-timeouts.html">Kotlin cancellation</a>:
<ul>
<li>You can invoke <code>cancel</code> on launched jobs (spawned tasks).</li>
<li>Cancelling sets a flag that the job can check for.</li>
<li>Builtin functions check for the flag and throw an exception if it is set.
<ul>
<li>If you need a builtin function to run post-cancellation, you can <a href="https://kotlinlang.org/docs/cancellation-and-timeouts.html#run-non-cancellable-block">run the code in a &quot;non-cancelable&quot; context</a>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="what-is-the-relationship-between-asyncdrop-and-cancellation"><a class="header" href="#what-is-the-relationship-between-asyncdrop-and-cancellation">What is the relationship between AsyncDrop and cancellation?</a></h3>
<p>In async Rust today, one signals cancellation of a future by (synchronously) dropping it. This <em>forces</em> the future to stop executing, and drops the values that are on the stack. Experience has shown that this is someting users have a lot of trouble doing correctly, particularly at fine granularities (see e.g. <a href="../submitted_stories/status_quo/alan_builds_a_cache.html">Alan builds a cache</a> or <a href="../submitted_stories/status_quo/barbara_gets_burned_by_select.html">Barbara gets burned by select</a>).</p>
<p>Given <code>AsyncDrop</code>, we could adopt a similar convention, where canceling an <code>Async</code> is done by (asynchronously) dropping it. This would presumably amend the unsafe contract of the <code>Async</code> trait so that the value must be polled to completion <em>or</em> async-dropped. To avoid the footguns we see today, a typical future could simply continue execution from its <code>AsyncDrop</code> method (but disregard the result). It might however set an internal flag to true or otherwise allow the user to find out that it has been canceled. It's not clear, though, precisely what value is being added by <code>AsyncDrop</code> in this scenario versus the <code>Async</code> simply not implementing <code>AsyncDrop</code> -- perhaps though it serves as an elegant way to give both an immediate &quot;cancellation&quot; callback and an opportunity to continue.</p>
<p>An alternative is to use a cancellation token of some kind, so that <em>scopes</em> can be canceled and that cancelation can be observed. The main reason to have that token or observation mechanism be &quot;built-in&quot; to some degree is so that it can be observed and used to drive &quot;voluntary cancellation&quot; from I/O routines and the like. Under that model, <code>AsyncDrop</code> would be intended more for values (like database handles) that have cleanup to be done, much like <code>Drop</code> today, and less as a way to signal cancellation.</p>
<h2 id="related-work"><a class="header" href="#related-work">Related Work</a></h2>
<ul>
<li><a href="https://blog.yoshuawuyts.com/async-cancellation-1/">Async Cancellation I (Yoshua Wuyts, 2021)</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../vision/roadmap/async_fn/async_main_and_tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../vision/roadmap/scopes/capability.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../vision/roadmap/async_fn/async_main_and_tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../vision/roadmap/scopes/capability.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </div>
    </body>
</html>
