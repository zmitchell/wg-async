<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Alan tries tries processing some files - wg-async</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item "><a href="../../../CHARTER.html"><strong aria-hidden="true">2.</strong> üìú Charter</a></li><li class="chapter-item "><a href="../../../meetings.html"><strong aria-hidden="true">3.</strong> ü§ù Meetings</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../triage.html"><strong aria-hidden="true">3.1.</strong> üîç Triage</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision.html"><strong aria-hidden="true">4.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision.html"><strong aria-hidden="true">4.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision/owners.html"><strong aria-hidden="true">4.1.1.</strong> Owning a goal or initiative</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/stakeholders.html"><strong aria-hidden="true">4.1.2.</strong> Being a stakeholder</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/evaluations.html"><strong aria-hidden="true">4.1.3.</strong> Writing an evaluation</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">4.1.4.</strong> Authoring "Status quo" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">4.1.5.</strong> Authoring "Shiny future" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/comment.html"><strong aria-hidden="true">4.1.6.</strong> Commenting on stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/awards.html"><strong aria-hidden="true">4.1.7.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../../vision/how_it_feels.html"><strong aria-hidden="true">4.2.</strong> ü•∞ How using async Rust ought to feel</a></li><li class="chapter-item "><a href="../../../vision/characters.html"><strong aria-hidden="true">4.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/characters/alan.html"><strong aria-hidden="true">4.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../../vision/characters/grace.html"><strong aria-hidden="true">4.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../../vision/characters/niklaus.html"><strong aria-hidden="true">4.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../../vision/characters/barbara.html"><strong aria-hidden="true">4.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../../vision/projects.html"><strong aria-hidden="true">4.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/projects/template.html"><strong aria-hidden="true">4.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">4.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../../vision/projects/DistriData.html"><strong aria-hidden="true">4.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">4.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/YouBuy.html"><strong aria-hidden="true">4.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../../vision/projects/SLOW.html"><strong aria-hidden="true">4.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item "><a href="../../../vision/status_quo.html"><strong aria-hidden="true">4.5.</strong> üò± Status quo</a></li><li class="chapter-item "><a href="../../../vision/shiny_future.html"><strong aria-hidden="true">4.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/shiny_future/users_manual.html"><strong aria-hidden="true">4.6.1.</strong> üìö User's manual of the future</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap.html"><strong aria-hidden="true">4.7.</strong> üìÖ Roadmap</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn.html"><strong aria-hidden="true">4.7.1.</strong> Async fn everywhere</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/boxable.html"><strong aria-hidden="true">4.7.1.1.</strong> Boxable async fn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/async_main_and_tests.html"><strong aria-hidden="true">4.7.1.2.</strong> Async main and tests</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes.html"><strong aria-hidden="true">4.7.2.</strong> Scoped spawn and reliable cancellation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability.html"><strong aria-hidden="true">4.7.2.1.</strong> Capability</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_async_trait.html"><strong aria-hidden="true">4.7.2.1.1.</strong> Variant: Async trait</a></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_leak.html"><strong aria-hidden="true">4.7.2.1.2.</strong> Variant: Leak trait</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/scope_api.html"><strong aria-hidden="true">4.7.2.2.</strong> Scope API</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter.html"><strong aria-hidden="true">4.7.3.</strong> Async iteration</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/traits.html"><strong aria-hidden="true">4.7.3.1.</strong> Traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/generators.html"><strong aria-hidden="true">4.7.3.2.</strong> Generators</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/portable.html"><strong aria-hidden="true">4.7.4.</strong> Portable and interoperable</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/portable/read_write.html"><strong aria-hidden="true">4.7.4.1.</strong> Read/write traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/timers.html"><strong aria-hidden="true">4.7.4.2.</strong> Timers</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/spawn.html"><strong aria-hidden="true">4.7.4.3.</strong> Spawn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/runtime.html"><strong aria-hidden="true">4.7.4.4.</strong> Runtime</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/polish.html"><strong aria-hidden="true">4.7.5.</strong> Polish</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_must_not_suspend.html"><strong aria-hidden="true">4.7.5.1.</strong> must_not_suspend lint</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_blocking_fns.html"><strong aria-hidden="true">4.7.5.2.</strong> Lint blocking fns</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_large_copies.html"><strong aria-hidden="true">4.7.5.3.</strong> Lint large copies</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/error_messages.html"><strong aria-hidden="true">4.7.5.4.</strong> Error messages for the most confusing scenarios</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/stacktraces.html"><strong aria-hidden="true">4.7.5.5.</strong> Stacktraces</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/precise_generator_captures.html"><strong aria-hidden="true">4.7.5.6.</strong> Precise Generator Captures</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/sync_and_async.html"><strong aria-hidden="true">4.7.5.7.</strong> Sync and async behave the same</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/tooling.html"><strong aria-hidden="true">4.7.6.</strong> Tooling</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/tooling/crashdump.html"><strong aria-hidden="true">4.7.6.1.</strong> Crashdump</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/testing.html"><strong aria-hidden="true">4.7.7.</strong> Testing</a></li><li class="chapter-item "><a href="../../../vision/roadmap/documentation.html"><strong aria-hidden="true">4.7.8.</strong> Documentation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/documentation/async_book.html"><strong aria-hidden="true">4.7.8.1.</strong> Async book</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/threadsafe_portability.html"><strong aria-hidden="true">4.7.9.</strong> Threadsafe portability</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_overloading.html"><strong aria-hidden="true">4.7.10.</strong> Async overloading</a></li></ol></li><li class="chapter-item "><a href="../../../vision/unresolved_questions.html"><strong aria-hidden="true">4.8.</strong> ‚ùì Major unresolved questions or controversies</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/unresolved_questions/default_runtime.html"><strong aria-hidden="true">4.8.1.</strong> Default runtime?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/async_fn.html"><strong aria-hidden="true">4.8.2.</strong> How to represent the AsyncFn traits?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/cancellation.html"><strong aria-hidden="true">4.8.3.</strong> How best to integrate voluntary cancellation?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/portable_without_generics.html"><strong aria-hidden="true">4.8.4.</strong> Extend stdlib to permit portable async without generics?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/await_or_not.html"><strong aria-hidden="true">4.8.5.</strong> To await or not to await?</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories.html"><strong aria-hidden="true">4.9.</strong> üíù Appendix: Submitted stories</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo.html"><strong aria-hidden="true">4.9.1.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/template.html"><strong aria-hidden="true">4.9.1.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_task_scheduler.html"><strong aria-hidden="true">4.9.1.2.</strong> Alan builds a task scheduler</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_creates_a_hanging_alarm.html"><strong aria-hidden="true">4.9.1.3.</strong> Alan creates a hanging alarm</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">4.9.1.4.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">4.9.1.5.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">4.9.1.6.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">4.9.1.7.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">4.9.1.8.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_misses_c_sharp_async.html"><strong aria-hidden="true">4.9.1.9.</strong> Alan misses C# async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">4.9.1.10.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">4.9.1.11.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">4.9.1.12.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">4.9.1.13.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">4.9.1.14.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">4.9.1.15.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">4.9.1.16.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo/alan_tries_processing_some_files.html" class="active"><strong aria-hidden="true">4.9.1.17.</strong> Alan tries tries processing some files</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html"><strong aria-hidden="true">4.9.1.18.</strong> Alan wants a prefetch iterator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">4.9.1.19.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">4.9.1.20.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer.html"><strong aria-hidden="true">4.9.1.21.</strong> Alan extends an AWS service</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">4.9.1.21.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">4.9.1.21.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">4.9.1.21.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">4.9.1.21.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">4.9.1.21.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">4.9.1.21.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">4.9.1.21.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html"><strong aria-hidden="true">4.9.1.21.8.</strong> Solving a deadlock</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">4.9.1.21.9.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">4.9.1.21.10.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">4.9.1.21.11.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_the_debugger.html"><strong aria-hidden="true">4.9.1.21.12.</strong> Using the debugger</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">4.9.1.21.13.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">4.9.1.21.14.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_ready_to_deploy.html"><strong aria-hidden="true">4.9.1.21.15.</strong> Getting ready to deply</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">4.9.1.21.16.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">4.9.1.22.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html"><strong aria-hidden="true">4.9.1.23.</strong> Barbara awants single threaded optimizations</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_battles_buffered_streams.html"><strong aria-hidden="true">4.9.1.24.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html"><strong aria-hidden="true">4.9.1.25.</strong> Barbara begets backpressure and benchmarks async_trait</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">4.9.1.26.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">4.9.1.27.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">4.9.1.28.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">4.9.1.29.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">4.9.1.30.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">4.9.1.31.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">4.9.1.32.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">4.9.1.33.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_polls_a_mutex.html"><strong aria-hidden="true">4.9.1.34.</strong> Barbara polls a Mutex</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">4.9.1.35.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_unix_socket.html"><strong aria-hidden="true">4.9.1.36.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">4.9.1.37.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">4.9.1.38.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">4.9.1.39.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wishes_for_easy_runtime_switch.html"><strong aria-hidden="true">4.9.1.40.</strong> Barbara wishes for an easy runtim switch</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">4.9.1.41.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_debugs_a_crash_dump.html"><strong aria-hidden="true">4.9.1.42.</strong> Grace debugs a crash dump</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">4.9.1.43.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">4.9.1.44.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">4.9.1.45.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_a_zero_copy_api.html"><strong aria-hidden="true">4.9.1.46.</strong> Grace wants a zero copy API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">4.9.1.47.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">4.9.1.48.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">4.9.1.49.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">4.9.1.50.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future.html"><strong aria-hidden="true">4.9.2.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/template.html"><strong aria-hidden="true">4.9.2.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">4.9.2.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">4.9.2.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">4.9.2.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">4.9.2.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">4.9.2.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">4.9.2.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">4.9.2.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">4.9.2.9.</strong> Barbara wants async tracing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/grace_debugs_a_crash_dump_again.html"><strong aria-hidden="true">4.9.2.10.</strong> Grace debugs a crash dump again</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../../design_docs.html"><strong aria-hidden="true">5.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/yield_safe.html"><strong aria-hidden="true">5.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../../design_docs/stream.html"><strong aria-hidden="true">5.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../../design_docs/generator_syntax.html"><strong aria-hidden="true">5.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../../design_docs/async_read_write.html"><strong aria-hidden="true">5.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">5.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../../design_docs/mutex.html"><strong aria-hidden="true">5.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../../design_docs/channels.html"><strong aria-hidden="true">5.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../../design_docs/async_closures.html"><strong aria-hidden="true">5.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../../design_docs/join.html"><strong aria-hidden="true">5.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../../design_docs/select.html"><strong aria-hidden="true">5.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../../design_docs/sink_trait.html"><strong aria-hidden="true">5.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../../design_docs/async_main.html"><strong aria-hidden="true">5.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../../design_docs/async_drop.html"><strong aria-hidden="true">5.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/async_lifecycle.html"><strong aria-hidden="true">5.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../../design_docs/completion_based_futures.html"><strong aria-hidden="true">5.14.</strong> ‚è≥ Completion-based futures</a></li><li class="chapter-item "><a href="../../../design_docs/async_stack_traces.html"><strong aria-hidden="true">5.15.</strong> ü•û Async Stack Traces</a></li></ol></li><li class="chapter-item "><a href="../../../conversations.html"><strong aria-hidden="true">6.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">6.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../../acknowledgments.html"><strong aria-hidden="true">7.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async/tree/master/src/vision/submitted_stories/status_quo/alan_tries_processing_some_files.md?mode&#x3D;edit" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-alan-tries-processing-some-files"><a class="header" href="#-status-quo-stories-alan-tries-processing-some-files">üò± Status quo stories: Alan tries processing some files</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today. </p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories [cannot be wrong], only inaccurate). Alternatively, you may wish to [add your own status quo story][htvsq]!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p>Alan is new to Rust. He wants to build a program that recurses over all the files in a directory (and its subdirectories), reads each file, and produces some fingerprint of the file.</p>
<p>Since so much blocking I/O is involved, he chooses async in order to process many files concurrently.</p>
<h3 id="async"><a class="header" href="#async">Async</a></h3>
<p>Alan does some research into <code>async</code> Rust. New to the language, he's heard that <code>async</code> support has recently landed, so he starts by reading <a href="https://blog.rust-lang.org/2019/11/07/Rust-1.39.0.html">the release notes</a> and much of the <a href="https://rust-lang.github.io/async-book/01_getting_started/01_chapter.html">Async Book</a>, bookmarking the dense parts about Pinning as something he'll come back to when it makes more sense. Notably, he skips over the <a href="https://rust-lang.github.io/async-book/07_workarounds/04_recursion.html">Recursion Workaround</a> and other workaround bits.</p>
<p>As someone who hasn't followed the evolution of <code>async</code> Rust closely, the <a href="https://rust-lang.github.io/async-book/08_ecosystem/00_chapter.html">Ecosystem</a> page of the Async Book provides a critical bit of context that he wishes he'd found first. Coming from Python and Go, where <code>asyncio</code> and goroutines are fully supported by the core language, Alan had been unclear exactly what <em>was</em> and what <em>wasn't</em> included in the language. This page puts everything into place.</p>
<p>The <a href="https://rust-lang.github.io/async-book/08_ecosystem/00_chapter.html#popular-async-runtimes">Popular Runtimes</a> section makes it clear that he'll need to choose a third party ecosystem. He chooses Tokio because:</p>
<ul>
<li>It's the only ecosystem of those listed that he's already heard about.</li>
<li>It seems to be widely used based on some web searches.</li>
<li>It has bite-sized, approachable <a href="https://tokio.rs/tokio/tutorial">tutorial pages</a> that provide higher-level introduction than the average <code>rustdoc</code>.</li>
<li>It provides rich RPC libraries, like Tonic, which he plans to fiddle with in a future project.</li>
</ul>
<h3 id="recursion"><a class="header" href="#recursion">Recursion</a></h3>
<p>Alan starts by writing a recursive function that can call some operation on each regular file in a directory and recurse on each subdirectory.</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn process_directory&lt;'a, F, P, T&gt;(path: PathBuf, processor: &amp;'a P) -&gt; Vec&lt;F&gt;
where
    P: Fn(DirEntry) -&gt; F,
    F: Future&lt;Output = T&gt;,
{
    ReadDirStream::new(read_dir(path).await.unwrap())
        .filter_map(|x| async {
            let dir_entry = x.unwrap();
            let ft = dir_entry.file_type().await.unwrap();
            if ft.is_file() {
                Some(vec![processor(dir_entry)])
            } else if ft.is_dir() {
                Some(process_directory(dir_entry.path(), processor).await)
            } else {
                None
            }
        })
        .collect::&lt;Vec&lt;Vec&lt;F&gt;&gt;&gt;()
        .await
        .into_iter()
        .flatten()
        .collect()
}
<span class="boring">}</span></code></pre></pre>
<p>The first paper cut comes when the compiler complains:</p>
<pre><code>error[E0733]: recursion in an `async fn` requires boxing
  --&gt; src/main.rs:23:77
   |
23 | async fn process_directory&lt;'a, F, P, T&gt;(path: PathBuf, processor: &amp;'a P) -&gt; Vec&lt;F&gt;
   |                                                                             ^^^^^^ recursive `async fn`
   |
   = note: a recursive `async fn` must be rewritten to return a boxed `dyn Future`

...
For more information about an error, try `rustc --explain E0733`.
</code></pre>
<p>From the explainer, Alan learns that he cannot use the <code>async</code> sugaring, and needs to use a Boxed Pin in his function signature:</p>
<pre><code>fn process_directory&lt;'a, F, P, T&gt;(
    path: PathBuf,
    processor: &amp;'static P,
) -&gt; Pin&lt;Box&lt;dyn Future&lt;Output = Vec&lt;F&gt;&gt;&gt;&gt;
</code></pre>
<p>New to Rust, Alan still doesn't really understand what <code>Pin</code> does, so he reads <a href="https://doc.rust-lang.org/std/pin/index.html">the docs</a>, sees that it marks which objects are <em>&quot;guaranteed not to move&quot;</em>, and wonders why the compiler couldn't determine this automatically since he read so much about how the borrow checker can already detect <em>moves</em> versus borrows.</p>
<p>He's also not entirely sure why the returned <code>Future</code> needs to be <code>Boxed</code>. The suggested explainer helps a bit:</p>
<pre><code>The `Box&lt;...&gt;` ensures that the result is of known size, and the pin is
required to keep it in the same place in memory.
</code></pre>
<p>But Alan figures that the size of <code>Future&lt;Output = T&gt;</code> should be determined by the type <code>T</code>. It's not like he's implementing a custom struct that is <code>Future</code>; he's returning a <code>Vec&lt;T&gt;</code> inside the standard <code>async move {}</code>. Alan wishes there was a way to express &quot;<em>Hey I'm returning a Future created by <code>async move</code>, whose <code>Output</code> attribute has a known size, so the resulting Future should have a known size too!</em>&quot;</p>
<p>But Alan does what the compiler tells him to do and adds some extra stuff to his function, which now looks like:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn process_directory&lt;'a, F, P, T&gt;(
    path: PathBuf,
    processor: &amp;'static P,
) -&gt; Pin&lt;Box&lt;dyn Future&lt;Output = Vec&lt;F&gt;&gt; + 'a&gt;&gt;
where
    P: Fn(DirEntry) -&gt; F,
    F: Future&lt;Output = T&gt;,
{
    Box::pin(async move {
        ReadDirStream::new(read_dir(path).await.unwrap())
            .filter_map(|x| async {
                let dir_entry = x.unwrap();
                let ft = dir_entry.file_type().await.unwrap();
                if ft.is_file() {
                    Some(vec![processor(dir_entry)])
                } else if ft.is_dir() {
                    Some(process_directory(dir_entry.path(), processor).await)
                } else {
                    None
                }
            })
            .collect::&lt;Vec&lt;Vec&lt;F&gt;&gt;&gt;()
            .await
            .into_iter()
            .flatten()
            .collect()
    })
}
<span class="boring">}</span></code></pre></pre>
<h3 id="rate-limiting"><a class="header" href="#rate-limiting">Rate Limiting</a></h3>
<p>Alan knows that <code>process_directory</code> may be called on directories with many thousands of files or subdirectories, and is wary of exhausting file descriptor limits. Since he can't find much documentation about how to keep the number of async tasks in check - Tokio's docs suggest we can <a href="https://tokio.rs/tokio/tutorial/spawning">spawn millions of tasks</a>, but don't offer advice on how to manage tasks with expensive side effects - he decides he needs to build a simple rate limiter.</p>
<p>Alan's rate limiter will wrap some <code>Future&lt;Output =T&gt;</code>, acquire a semaphore, and then await the Future, returning the same type <code>T</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn rate_limit&lt;F, T&gt;(fut: F, sem: &amp;Semaphore) -&gt; T
where
    F: Future&lt;Output = T&gt;,
{
    let _permit = sem.acquire().await;
    fut.await
}
<span class="boring">}</span></code></pre></pre>
<p>Since the <code>async fn foo&lt;T&gt;() -&gt; T</code> syntax desugars to <code>fn foo&lt;T&gt;() -&gt; Future&lt;Output = T&gt;</code>, and since <code>fut.await</code> returns <code>T</code>, Alan assumes that the above is equivalent to:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn rate_limit&lt;F, T&gt;(fut: F, sem: &amp;Semaphore) -&gt; F
where
    F: Future&lt;Output = T&gt;,
{
    ...
}
<span class="boring">}</span></code></pre></pre>
<p>So he plugs this new <code>rate_limit</code> logic into <code>process_directory</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">use futures::future::join_all;                 
use futures::stream::StreamExt;                
use futures::Future;                           
use std::path::PathBuf;                        
use std::pin::Pin;                                    
use tokio::fs::{read_dir, DirEntry};     
use tokio::sync::Semaphore;                    
use tokio_stream::wrappers::ReadDirStream;     

async fn rate_limit&lt;F, T&gt;(fut: F, sem: &amp;Semaphore) -&gt; T
where
    F: Future&lt;Output = T&gt;,
{
    let _permit = sem.acquire().await;
    fut.await
}

fn process_directory&lt;'a, F, P, T&gt;(
    path: PathBuf,
    processor: &amp;'a P,
    sem: &amp;'static Semaphore,
) -&gt; Pin&lt;Box&lt;dyn Future&lt;Output = Vec&lt;F&gt;&gt; + 'a&gt;&gt;
where
    P: Fn(DirEntry) -&gt; F,
    F: Future&lt;Output = T&gt;,
{
    Box::pin(async move {
        ReadDirStream::new(read_dir(path).await.unwrap())
            .filter_map(|x| async {
                let dir_entry = x.unwrap();
                let ft = dir_entry.file_type().await.unwrap();
                if ft.is_file() {
                    Some(vec![rate_limit(processor(dir_entry), sem)])
                } else if ft.is_dir() {
                    Some(process_directory(dir_entry.path(), processor, sem).await)
                } else {
                    None
                }
            })
            .collect::&lt;Vec&lt;Vec&lt;F&gt;&gt;&gt;()
            .await
            .into_iter()
            .flatten()
            .collect()
    })
}

async fn expensive(de: DirEntry) -&gt; usize {
    // assume this function spawns a task that does heavy I/O on the file
    de.file_name().len()
}

#[tokio::main(flavor = &quot;current_thread&quot;)]
async fn main() {
    let sem = Semaphore::new(10);
    let path = PathBuf::from(&quot;/tmp/foo&quot;);
    let results = join_all(process_directory(path, &amp;expensive, &amp;sem).await);
    dbg!(results.await);
}</code></pre></pre>
<p>And is met with a new complaint from the compiler:</p>
<pre><code>error[E0308]: `if` and `else` have incompatible types
  --&gt; src/main.rs:34:24
   |
18 |    fn process_directory&lt;'a, F, P, T&gt;(
   |                             - this type parameter
...
32 |  /                 if ft.is_file() {
33 |  |                     Some(vec![rate_limit(processor(dir_entry), sem)])
   |  |                     ------------------------------------------------- expected because of this
34 |  |                 } else if ft.is_dir() {
   |  |________________________^
35 | ||                     Some(process_directory(dir_entry.path(), processor, sem).await)
36 | ||                 } else {
37 | ||                     None
38 | ||                 }
   | ||                 ^
   | ||_________________|
   | |__________________`if` and `else` have incompatible types
   |                    expected opaque type, found type parameter `F`
   |
   = note: expected type `Option&lt;Vec&lt;impl futures::Future&gt;&gt;`
              found enum `Option&lt;Vec&lt;F&gt;&gt;`
   = help: type parameters must be constrained to match other types
   = note: for more information, visit https://doc.rust-lang.org/book/ch10-02-traits.html#traits-as-parameters
</code></pre>
<p>Alan is confused. In line 33, <code>rate_limit</code> returns <code>Future&lt;Output = usize&gt;</code>, so why is this an opaque <code>Future</code>? So far as he can tell, the <code>Option&lt;Vec&lt;impl futures::Future&lt;Output = usize&gt;</code> returned on line 33 is the same type as the <code>Option&lt;Vec&lt;F&gt;&gt;</code> where <code>F: Future&lt;Output = usize&gt;</code> returned on line 35.</p>
<p>So he strips the problem down to only a few lines of code, and still he cannot figure out why the compiler complains:</p>
<pre><pre class="playground"><code class="language-rust edition2018">use futures::{future::pending, Future};

async fn passthru&lt;F, T&gt;(fut: F) -&gt; T
where
    F: Future&lt;Output = T&gt;,
{
    fut.await
}

fn main() {
    let func = pending::&lt;u8&gt;;
    match true {
        true =&gt; passthru(func()),
        false =&gt; func(),
    };
}</code></pre></pre>
<p>To which the compiler nevertheless replies:</p>
<pre><code>error[E0308]: `match` arms have incompatible types
  --&gt; src/main.rs:14:18
   |
12 | /     match true {
13 | |         true =&gt; passthru(func()),
   | |                 ---------------- this is found to be of type `impl futures::Future`
14 | |         false =&gt; func(),
   | |                  ^^^^^^ expected opaque type, found struct `futures::future::Pending`
15 | |     };
   | |_____- `match` arms have incompatible types
   |
   = note: expected type `impl futures::Future`
            found struct `futures::future::Pending&lt;u8&gt;`
</code></pre>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<ul>
<li>The manual desugaring required for <code>async</code> recursion erases some of the &quot;magic&quot; of <code>async</code>.</li>
<li>Some programmers may never implement custom types that are <code>Future</code>, instead using standard constructs like <code>async</code> blocks to produce them. In these cases, the programmer might assume the returned <code>Future</code>s should have concrete types with known sizes, which would allow them to work directly with the returned types rather than have to deal with the complexities of trait objects, <code>Box</code>-ing, and opaque type comparisons.</li>
<li><code>Pin</code> documentation focuses on data that can or cannot &quot;move&quot; in memory. To someone new to Rust, it might be easy to confuse this concept with &quot;move&quot; semantics in the context of ownership.</li>
</ul>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<p>I describe my own experience while working on my first Rust project.</p>
<h3 id="why-did-you-choose-alan-to-tell-this-story"><a class="header" href="#why-did-you-choose-alan-to-tell-this-story"><strong>Why did you choose Alan to tell this story?</strong></a></h3>
<p>I chose Alan to tell this story because I envision him comping from Python. I mostly work in <code>asyncio</code> Python by day, which means my exposure to async is shaped by what I'd expect from a language without traits, and one where heap wrangling and memory addressing is abstracted away.</p>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<p>I'm not sure, but I'd assume:</p>
<ul>
<li><strong>Grace</strong> would not get tripped up on the need for <code>Box::pin</code></li>
<li><strong>Niklaus</strong> might share the confusion expressed above</li>
<li><strong>Barbara</strong> might wish we could use <code>async</code> sugaring in recursive functions.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../vision/submitted_stories/status_quo/alan_builds_a_cache.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../vision/submitted_stories/status_quo/alan_builds_a_cache.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../mermaid.min.js"></script>
        <script src="../../../mermaid-init.js"></script>


    </div>
    </body>
</html>
