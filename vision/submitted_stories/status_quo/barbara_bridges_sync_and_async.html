<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Barbara bridges sync and async in perf.rust-lang.org - wg-async</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../welcome.html"><strong aria-hidden="true">1.</strong> 👋🏽 Welcome</a></li><li class="chapter-item "><a href="../../../CHARTER.html"><strong aria-hidden="true">2.</strong> 📜 Charter</a></li><li class="chapter-item "><a href="../../../meetings.html"><strong aria-hidden="true">3.</strong> 🤝 Meetings</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../triage.html"><strong aria-hidden="true">3.1.</strong> 🔍 Triage</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision.html"><strong aria-hidden="true">4.</strong> 🔮 The vision</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision.html"><strong aria-hidden="true">4.1.</strong> ❓How to vision</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision/owners.html"><strong aria-hidden="true">4.1.1.</strong> Owning a goal or initiative</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/stakeholders.html"><strong aria-hidden="true">4.1.2.</strong> Being a stakeholder</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/evaluations.html"><strong aria-hidden="true">4.1.3.</strong> Writing an evaluation</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">4.1.4.</strong> Authoring "Status quo" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">4.1.5.</strong> Authoring "Shiny future" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/comment.html"><strong aria-hidden="true">4.1.6.</strong> Commenting on stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/awards.html"><strong aria-hidden="true">4.1.7.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../../vision/how_it_feels.html"><strong aria-hidden="true">4.2.</strong> 🥰 How using async Rust ought to feel</a></li><li class="chapter-item "><a href="../../../vision/characters.html"><strong aria-hidden="true">4.3.</strong> 🙋‍♀️ Cast of characters</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/characters/alan.html"><strong aria-hidden="true">4.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../../vision/characters/grace.html"><strong aria-hidden="true">4.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../../vision/characters/niklaus.html"><strong aria-hidden="true">4.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../../vision/characters/barbara.html"><strong aria-hidden="true">4.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../../vision/projects.html"><strong aria-hidden="true">4.4.</strong> ⚡ Projects</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/projects/template.html"><strong aria-hidden="true">4.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">4.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../../vision/projects/DistriData.html"><strong aria-hidden="true">4.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">4.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/YouBuy.html"><strong aria-hidden="true">4.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../../vision/projects/SLOW.html"><strong aria-hidden="true">4.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item "><a href="../../../vision/status_quo.html"><strong aria-hidden="true">4.5.</strong> 😱 Status quo</a></li><li class="chapter-item "><a href="../../../vision/shiny_future.html"><strong aria-hidden="true">4.6.</strong> ✨ Shiny future</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/shiny_future/users_manual.html"><strong aria-hidden="true">4.6.1.</strong> 📚 User's manual of the future</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap.html"><strong aria-hidden="true">4.7.</strong> 📅 Roadmap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn.html"><strong aria-hidden="true">4.7.1.</strong> Async fn everywhere</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/boxable.html"><strong aria-hidden="true">4.7.1.1.</strong> Boxable async fn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/async_main_and_tests.html"><strong aria-hidden="true">4.7.1.2.</strong> Async main and tests</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes.html"><strong aria-hidden="true">4.7.2.</strong> Scoped spawn and reliable cancellation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability.html"><strong aria-hidden="true">4.7.2.1.</strong> Capability</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_async_trait.html"><strong aria-hidden="true">4.7.2.1.1.</strong> Variant: Async trait</a></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_leak.html"><strong aria-hidden="true">4.7.2.1.2.</strong> Variant: Leak trait</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/scope_api.html"><strong aria-hidden="true">4.7.2.2.</strong> Scope API</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter.html"><strong aria-hidden="true">4.7.3.</strong> Async iteration</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/traits.html"><strong aria-hidden="true">4.7.3.1.</strong> Traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/generators.html"><strong aria-hidden="true">4.7.3.2.</strong> Generators</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/portable.html"><strong aria-hidden="true">4.7.4.</strong> Portable and interoperable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/portable/read_write.html"><strong aria-hidden="true">4.7.4.1.</strong> Read/write traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/timers.html"><strong aria-hidden="true">4.7.4.2.</strong> Timers</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/spawn.html"><strong aria-hidden="true">4.7.4.3.</strong> Spawn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/runtime.html"><strong aria-hidden="true">4.7.4.4.</strong> Runtime</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/polish.html"><strong aria-hidden="true">4.7.5.</strong> Polish</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_must_not_suspend.html"><strong aria-hidden="true">4.7.5.1.</strong> must_not_suspend lint</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_blocking_fns.html"><strong aria-hidden="true">4.7.5.2.</strong> Lint blocking fns</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_large_copies.html"><strong aria-hidden="true">4.7.5.3.</strong> Lint large copies</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/error_messages.html"><strong aria-hidden="true">4.7.5.4.</strong> Error messages for the most confusing scenarios</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/stacktraces.html"><strong aria-hidden="true">4.7.5.5.</strong> Stacktraces</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/precise_generator_captures.html"><strong aria-hidden="true">4.7.5.6.</strong> Precise Generator Captures</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/sync_and_async.html"><strong aria-hidden="true">4.7.5.7.</strong> Sync and async behave the same</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/tooling.html"><strong aria-hidden="true">4.7.6.</strong> Tooling</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/tooling/crashdump.html"><strong aria-hidden="true">4.7.6.1.</strong> Crashdump</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/testing.html"><strong aria-hidden="true">4.7.7.</strong> Testing</a></li><li class="chapter-item "><a href="../../../vision/roadmap/documentation.html"><strong aria-hidden="true">4.7.8.</strong> Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/documentation/async_book.html"><strong aria-hidden="true">4.7.8.1.</strong> Async book</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/threadsafe_portability.html"><strong aria-hidden="true">4.7.9.</strong> Threadsafe portability</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_overloading.html"><strong aria-hidden="true">4.7.10.</strong> Async overloading</a></li></ol></li><li class="chapter-item "><a href="../../../vision/unresolved_questions.html"><strong aria-hidden="true">4.8.</strong> ❓ Major unresolved questions or controversies</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/unresolved_questions/default_runtime.html"><strong aria-hidden="true">4.8.1.</strong> Default runtime?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/async_fn.html"><strong aria-hidden="true">4.8.2.</strong> How to represent the AsyncFn traits?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/cancellation.html"><strong aria-hidden="true">4.8.3.</strong> How best to integrate voluntary cancellation?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/portable_without_generics.html"><strong aria-hidden="true">4.8.4.</strong> Extend stdlib to permit portable async without generics?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/await_or_not.html"><strong aria-hidden="true">4.8.5.</strong> To await or not to await?</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories.html"><strong aria-hidden="true">4.9.</strong> 💝 Appendix: Submitted stories</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo.html"><strong aria-hidden="true">4.9.1.</strong> 😱 Status quo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/template.html"><strong aria-hidden="true">4.9.1.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_task_scheduler.html"><strong aria-hidden="true">4.9.1.2.</strong> Alan builds a task scheduler</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_creates_a_hanging_alarm.html"><strong aria-hidden="true">4.9.1.3.</strong> Alan creates a hanging alarm</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">4.9.1.4.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">4.9.1.5.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">4.9.1.6.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">4.9.1.7.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">4.9.1.8.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_misses_c_sharp_async.html"><strong aria-hidden="true">4.9.1.9.</strong> Alan misses C# async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">4.9.1.10.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">4.9.1.11.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">4.9.1.12.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">4.9.1.13.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">4.9.1.14.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">4.9.1.15.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">4.9.1.16.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_processing_some_files.html"><strong aria-hidden="true">4.9.1.17.</strong> Alan tries tries processing some files</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html"><strong aria-hidden="true">4.9.1.18.</strong> Alan wants a prefetch iterator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">4.9.1.19.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">4.9.1.20.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer.html"><strong aria-hidden="true">4.9.1.21.</strong> Alan extends an AWS service</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">4.9.1.21.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">4.9.1.21.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">4.9.1.21.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">4.9.1.21.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">4.9.1.21.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">4.9.1.21.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">4.9.1.21.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html"><strong aria-hidden="true">4.9.1.21.8.</strong> Solving a deadlock</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">4.9.1.21.9.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">4.9.1.21.10.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">4.9.1.21.11.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_the_debugger.html"><strong aria-hidden="true">4.9.1.21.12.</strong> Using the debugger</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">4.9.1.21.13.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">4.9.1.21.14.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_ready_to_deploy.html"><strong aria-hidden="true">4.9.1.21.15.</strong> Getting ready to deply</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">4.9.1.21.16.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">4.9.1.22.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html"><strong aria-hidden="true">4.9.1.23.</strong> Barbara awants single threaded optimizations</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_battles_buffered_streams.html"><strong aria-hidden="true">4.9.1.24.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html"><strong aria-hidden="true">4.9.1.25.</strong> Barbara begets backpressure and benchmarks async_trait</a></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.html" class="active"><strong aria-hidden="true">4.9.1.26.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">4.9.1.27.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">4.9.1.28.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">4.9.1.29.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">4.9.1.30.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">4.9.1.31.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">4.9.1.32.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">4.9.1.33.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_polls_a_mutex.html"><strong aria-hidden="true">4.9.1.34.</strong> Barbara polls a Mutex</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">4.9.1.35.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_unix_socket.html"><strong aria-hidden="true">4.9.1.36.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">4.9.1.37.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">4.9.1.38.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">4.9.1.39.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wishes_for_easy_runtime_switch.html"><strong aria-hidden="true">4.9.1.40.</strong> Barbara wishes for an easy runtim switch</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">4.9.1.41.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_debugs_a_crash_dump.html"><strong aria-hidden="true">4.9.1.42.</strong> Grace debugs a crash dump</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">4.9.1.43.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">4.9.1.44.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">4.9.1.45.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_a_zero_copy_api.html"><strong aria-hidden="true">4.9.1.46.</strong> Grace wants a zero copy API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">4.9.1.47.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">4.9.1.48.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">4.9.1.49.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">4.9.1.50.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future.html"><strong aria-hidden="true">4.9.2.</strong> ✨ Shiny future</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/template.html"><strong aria-hidden="true">4.9.2.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">4.9.2.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">4.9.2.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">4.9.2.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">4.9.2.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">4.9.2.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">4.9.2.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">4.9.2.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">4.9.2.9.</strong> Barbara wants async tracing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/grace_debugs_a_crash_dump_again.html"><strong aria-hidden="true">4.9.2.10.</strong> Grace debugs a crash dump again</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../../design_docs.html"><strong aria-hidden="true">5.</strong> 🔬 Design docs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/yield_safe.html"><strong aria-hidden="true">5.1.</strong> ⚠️ Yield-safe lint</a></li><li class="chapter-item "><a href="../../../design_docs/stream.html"><strong aria-hidden="true">5.2.</strong> ☔ Stream trait</a></li><li class="chapter-item "><a href="../../../design_docs/generator_syntax.html"><strong aria-hidden="true">5.3.</strong> ⚡ Generator syntax</a></li><li class="chapter-item "><a href="../../../design_docs/async_read_write.html"><strong aria-hidden="true">5.4.</strong> 📝 AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">5.5.</strong> 🧬 Async fn in traits</a></li><li class="chapter-item "><a href="../../../design_docs/mutex.html"><strong aria-hidden="true">5.6.</strong> 🔒 Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../../design_docs/channels.html"><strong aria-hidden="true">5.7.</strong> 📺 Async aware channels</a></li><li class="chapter-item "><a href="../../../design_docs/async_closures.html"><strong aria-hidden="true">5.8.</strong> 📦 Async closures</a></li><li class="chapter-item "><a href="../../../design_docs/join.html"><strong aria-hidden="true">5.9.</strong> 🤝 Join combinator</a></li><li class="chapter-item "><a href="../../../design_docs/select.html"><strong aria-hidden="true">5.10.</strong> 🤷‍♀️ Select combinator</a></li><li class="chapter-item "><a href="../../../design_docs/sink_trait.html"><strong aria-hidden="true">5.11.</strong> 🚰 Sink trait</a></li><li class="chapter-item "><a href="../../../design_docs/async_main.html"><strong aria-hidden="true">5.12.</strong> 🎇 Async main</a></li><li class="chapter-item "><a href="../../../design_docs/async_drop.html"><strong aria-hidden="true">5.13.</strong> 🗑️ Async drop</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/async_lifecycle.html"><strong aria-hidden="true">5.13.1.</strong> ♻️ Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../../design_docs/completion_based_futures.html"><strong aria-hidden="true">5.14.</strong> ⏳ Completion-based futures</a></li><li class="chapter-item "><a href="../../../design_docs/async_stack_traces.html"><strong aria-hidden="true">5.15.</strong> 🥞 Async Stack Traces</a></li></ol></li><li class="chapter-item "><a href="../../../conversations.html"><strong aria-hidden="true">6.</strong> 💬 Conversations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">6.1.</strong> 🐦 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../../acknowledgments.html"><strong aria-hidden="true">7.</strong> ❤️ Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async/tree/master/src/vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.md?mode&#x3D;edit" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-barbara-bridges-sync-and-async-in-perfrust-langorg"><a class="header" href="#-status-quo-stories-barbara-bridges-sync-and-async-in-perfrust-langorg">😱 Status quo stories: Barbara bridges sync and async in <code>perf.rust-lang.org</code></a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">🚧 Warning: Draft status 🚧</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today.</p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories <a href="../../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p>Barbara is working on the code for <a href="https://perf.rust-lang.org/">perf.rust-lang.org</a> and she wants to do a web request to load various intermediate results. She has heard that the <code>reqwest</code> crate is quite nice, so she decides to give it a try. She writes up an async function that does her web request:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_web_request(url: &amp;Url) -&gt; Data {
    ...
}
<span class="boring">}</span></code></pre></pre>
<p>She needs to apply this async function to a number of urls. She wants to use the iterator map function, like so:</p>
<pre><pre class="playground"><code class="language-rust edition2018">async fn do_web_request(url: &amp;Url) -&gt; Data {...}

fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    urls
        .iter()
        .map(|url| do_web_request(url))
        .collect()
}

fn main() {
    /* do stuff */
    let data = aggregate();
    /* do more stuff */
}</code></pre></pre>
<p>Of course, since <code>do_web_request</code> is an async fn, she gets a type error from the compiler:</p>
<pre><code>error[E0277]: a value of type `Vec&lt;Data&gt;` cannot be built from an iterator over elements of type `impl Future`
  --&gt; src/main.rs:11:14
   |
11 |             .collect();
   |              ^^^^^^^ value of type `Vec&lt;Data&gt;` cannot be built from `std::iter::Iterator&lt;Item=impl Future&gt;`
   |
   = help: the trait `FromIterator&lt;impl Future&gt;` is not implemented for `Vec&lt;Data&gt;`
</code></pre>
<p>&quot;Of course,&quot; she thinks, &quot;I can't call an async function from a closure.&quot;</p>
<h3 id="introducing-block_on"><a class="header" href="#introducing-block_on">Introducing <code>block_on</code></a></h3>
<p>She decides that since she is not overly concerned about performance, so she decides she'll just use a call to <a href="https://docs.rs/futures/0.3.14/futures/executor/fn.block_on.html"><code>block_on</code> from the <code>futures</code> crate</a> and execute the function synchronously:</p>
<pre><pre class="playground"><code class="language-rust edition2018">async fn do_web_request(url: &amp;Url) -&gt; Data {...}

fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    urls
        .iter()
        .map(|url| futures::executor::block_on(do_web_request(url)))
        .collect()
}

fn main() {
    /* do stuff */
    let data = aggregate();
    /* do more stuff */
}</code></pre></pre>
<p>The code compiles, and it seems to work.</p>
<h3 id="switching-to-async-main"><a class="header" href="#switching-to-async-main">Switching to async main</a></h3>
<p>As Barbara works on <a href="https://perf.rust-lang.org/">perf.rust-lang.org</a>, she realizes that she needs to do more and more async operations. She decides to convert her synchronous <code>main</code> function into an <code>async main</code>. She's using tokio, so she is able to do this very conveniently with the <code>#[tokio::main]</code> decorator:</p>
<pre><pre class="playground"><code class="language-rust edition2018">#[tokio::main]
async fn main() {
    /* do stuff */
    let data = aggregate();
    /* do more stuff */
}</code></pre></pre>
<p>Everything seems to work ok on her laptop, but when she pushes the code to production, it deadlocks immediately. &quot;What's this?&quot; she says. Confused, she runs the code on her laptop a few more times, but it seems to work fine. (There's a faq explaining what's going on. -ed.)</p>
<p>She decides to try debugging. She fires up a debugger but finds it is isn't really giving her useful information about what is stuck (she has <a href="https://rust-lang.github.io/wg-async/vision/status_quo/alan_tries_to_debug_a_hang.html">basically the same problems that Alan has</a>). <a href="https://rust-lang.github.io/wg-async/vision/status_quo/barbara_wants_async_insights.html">She wishes she could get insight into tokio's state.</a></p>
<p>Frustrated, she starts reading the tokio docs more closely and she realizes that <code>tokio</code> runtimes offer their own <code>block_on</code> method. &quot;Maybe using tokio's <code>block_on</code> will help?&quot; she thinks, &quot;Worth a try, anyway.&quot; She changes the <code>aggregate</code> function to use tokio's <code>block_on</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn block_on&lt;O&gt;(f: impl Future&lt;Output = O&gt;) -&gt; O {
    let rt = tokio::runtime::Runtime::new().unwrap();
    rt.block_on(f)
}

fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    urls
        .iter()
        .map(|url| block_on(do_web_request(url)))
        .collect()
}
<span class="boring">}</span></code></pre></pre>
<p>The good news is that the deadlock is gone. The bad news is that now she is getting a panic:</p>
<blockquote>
<p>thread 'main' panicked at 'Cannot start a runtime from within a runtime. This happens because a function (like <code>block_on</code>) attempted to block the current thread while the thread is being used to drive asynchronous tasks.'</p>
</blockquote>
<p>&quot;Well,&quot; she thinks, &quot;I could use the <code>Handle</code> API to get the current runtime instead of creating a new one? Maybe that's the problem.&quot;</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn aggregate(urls: &amp;[&amp;str]) -&gt; Vec&lt;String&gt; {
    let handle = tokio::runtime::Handle::current();
    urls.iter()
        .map(|url| handle.block_on(do_web_request(url)))
        .collect()
}
<span class="boring">}</span></code></pre></pre>
<p>But this also seems to panic in the same way.</p>
<h3 id="trying-out-spawn_blocking"><a class="header" href="#trying-out-spawn_blocking">Trying out <code>spawn_blocking</code></a></h3>
<p>Reading more into this problem, she realizes she is supposed to be using <code>spawn_blocking</code>. She tries replacing <code>block_on</code> with <code>tokio::task::spawn_blocking</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    urls
        .iter()
        .map(|url| tokio::task::spawn_blocking(move || do_web_request(url)))
        .collect()
}
<span class="boring">}</span></code></pre></pre>
<p>but now she gets a type error again:</p>
<pre><code>error[E0277]: a value of type `Vec&lt;Data&gt;` cannot be built from an iterator over elements of type `tokio::task::JoinHandle&lt;impl futures::Future&gt;`
  --&gt; src/main.rs:22:14
   |
22 |             .collect();
   |              ^^^^^^^ value of type `Vec&lt;Data&gt;` cannot be built from `std::iter::Iterator&lt;Item=tokio::task::JoinHandle&lt;impl futures::Future&gt;&gt;`
   |
   = help: the trait `FromIterator&lt;tokio::task::JoinHandle&lt;impl futures::Future&gt;&gt;` is not implemented for `Vec&lt;Data&gt;`
</code></pre>
<p>Of course! <code>spawn_blocking</code>, like <code>map</code>, just takes a regular closure, not an async closure; it's purpose is to embed some sync code within an async task, so a sync closure makes sense -- and moreover async closures aren't stable -- but it's all rather frustrating nonetheless. &quot;Well,&quot; she thinks, &quot;I can use <code>spawn</code> to get back into an async context!&quot; So she adds a call to <code>spawn</code> inside the <code>spawn_blocking</code> closure:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    urls
        .iter()
        .map(|url| tokio::task::spawn_blocking(move || {
            tokio::task::spawn(async move {
                do_web_request(url).await
            })
        }))
        .collect()
}
<span class="boring">}</span></code></pre></pre>
<p>But this isn't really helping, as <code>spawn</code> still yields a future. She's getting the same errors.</p>
<h3 id="trying-out-join_all"><a class="header" href="#trying-out-join_all">Trying out <code>join_all</code></a></h3>
<p>She remembers now that this whole drama started because she was converting her <code>main</code> function to be <code>async</code>. Maybe she doesn't have to bridge between sync and async? She starts digging around in the docs and finds <code>futures::join_all</code>. Using that, she can change <code>aggregate</code> to be an async function too:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    futures::join_all(
        urls
            .iter()
            .map(|url| do_web_request(url))
    ).await
}
<span class="boring">}</span></code></pre></pre>
<p>Things are working again now, so she is happy, although she notes that <code>join_all</code> has quadratic time complexity. That's not great.</p>
<h3 id="filtering"><a class="header" href="#filtering">Filtering</a></h3>
<p>Later on, she would like to apply a filter to the aggregation operation. She realizes that if she wants to use the fetched data when doing the filtering, she has to filter the vector after the join has completed. She wants to write something like</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    futures::join_all(
        urls
            .iter()
            .map(|url| do_web_request(url))
            .filter(|data| test(data))
    ).await
}
<span class="boring">}</span></code></pre></pre>
<p>but she can't, because <code>data</code> is a future and not the <code>Data</code> itself. Instead she has to build the vector first and then post-process it:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    let mut data: Vec&lt;Data&gt; = futures::join_all(
        urls
            .iter()
            .map(|url| do_web_request(url))
    ).await;
    data.retain(test);
    data
}
<span class="boring">}</span></code></pre></pre>
<p>This is annoying, but performance isn't critical, so it's ok.</p>
<h3 id="and-the-cycle-begins-again"><a class="header" href="#and-the-cycle-begins-again">And the cycle begins again</a></h3>
<p>Later on, she wants to call <code>aggregate</code> from another binary. This one doesn't have an <code>async main</code>. This context is deep inside of an iterator chain and was previously entirely synchronous. She realizes it would be a lot of work to change all the intervening stack frames to be <code>async fn</code>, rewrite the iterators into streams, etc. She decides to just call <code>block_on</code> again, even though it make her nervous.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">🤔 Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story">What are the morals of the story?</a></h3>
<ul>
<li>Some projects don't care about max performance and just want things to work once the program compiles.
<ul>
<li>They would probably be happy with sync but as the most popular libraries for web requests, databases, etc, offer async interfaces, they may still be using async code.</li>
</ul>
</li>
<li>There are contexts where you can't easily add an <code>await</code>.
<ul>
<li>For example, inside of an iterator chain.</li>
<li>Big block of existing code.</li>
</ul>
</li>
<li>Mixing sync and async code can cause deadlocks that are really painful to diagnose, particularly when you have an async-sync-async sandwich.</li>
</ul>
<h3 id="why-did-you-choose-barbara-to-tell-this-story"><a class="header" href="#why-did-you-choose-barbara-to-tell-this-story">Why did you choose Barbara to tell this story?</a></h3>
<ul>
<li>Because Mark (who experienced most of it) is a very experienced Rust developer.</li>
<li>Because you could experience this story regardless of language background or being new to Rust.</li>
</ul>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters">How would this story have played out differently for the other characters?</a></h3>
<p>I would expect it would work out fairly similarly, except that the type errors and things might well have been more challenging for people to figure out, assuming they aren't already familiar with Rust.</p>
<h3 id="why-did-barbara-only-get-deadlocks-in-production-and-not-on-her-laptop"><a class="header" href="#why-did-barbara-only-get-deadlocks-in-production-and-not-on-her-laptop">Why did Barbara only get deadlocks in production, and not on her laptop?</a></h3>
<p>This is because the production instance she was using had only a single core, but her laptop is a multicore machine. The actual cause of the deadlocks is that <code>block_on</code> basically &quot;takes over&quot; the tokio worker thread, and hence the tokio scheduler cannot run. If that <code>block_on</code> is blocked on another future that will have to execute, then some other thread must take over of completing that future. On Barbara's multicore machine, there were more threads available, so the system did not deadlock. But on the production instance, there was only a single thread. Barbara could have encountered deadlocks on her local machine as well if she had enough instances of <code>block_on</code> running at once.</p>
<h3 id="could-the-runtime-have-prevented-the-deadlock"><a class="header" href="#could-the-runtime-have-prevented-the-deadlock">Could the runtime have prevented the deadlock?</a></h3>
<p>One way to resolve this problem would be to have a runtime that creates more threads as needed. This is what was proposed <a href="https://async.rs/blog/stop-worrying-about-blocking-the-new-async-std-runtime/">in this blog post</a>, for example.</p>
<p>Adapting the number of worker threads has downsides. It requires knowing the right threshold for creating new threads (which is fundamentally unknowable). The result is that the runtime will sometimes observe that some thread seems to be taking a long time and create new threads <em>just before</em> that thread was about to finish. These new threads generate overhead and lower the overall performance. It also requires work stealing and other techniques that can lead to work running on mulitple cores and having less locality. Systems tuned for maximal performance tend to prefer a single thread per core for this reason.</p>
<p>If some runtimes are adaptive, that may also lead to people writing libraries which block without caring. These libraries would then be a performance or deadlock hazard when used on a runtime that is not adaptive.</p>
<h3 id="is-there-any-way-to-have-kept-aggregate-as-a-synchronous-function"><a class="header" href="#is-there-any-way-to-have-kept-aggregate-as-a-synchronous-function">Is there any way to have kept <code>aggregate</code> as a synchronous function?</a></h3>
<p>Yes, Barbara could have written something like this:</p>
<pre><pre class="playground"><code class="language-rust edition2018">fn aggregate(urls: &amp;[Url]) -&gt; Vec&lt;Data&gt; {
    let handle = Handle::current();

    urls.iter()
        .map(|url| handle.block_on(do_web_request(url)))
        .collect()
}

#[tokio::main]
async fn main() {
    let data = task::spawn_blocking(move || aggregate(&amp;[Url, Url]))
        .await
        .unwrap();
    println!(&quot;done&quot;);
}</code></pre></pre>
<p>This <code>aggregate</code> function can only safely be invoked from inside a tokio <code>spawn_blocking</code> call, however, since <code>Handle::current</code> will only work in that context. She could also have used the original futures variant of <code>block_on</code>, in that case, and things would also work.</p>
<h3 id="why-didnt-barbara-just-use-the-sync-api-for-reqwest"><a class="header" href="#why-didnt-barbara-just-use-the-sync-api-for-reqwest">Why didn't Barbara just use the sync API for reqwest?</a></h3>
<p>reqwest does offer a synchronous API, but it's not enabled by default, you have to use an optional feature. Further, not all crates offer synchronous APIs. Finally, Barbara has had some vague poor experience when using synchronous APIs, such as panics, and so she's learned the heuristic of &quot;use the async API unless you're doing something really, really simple&quot;.</p>
<p>Regardless, the synchronous reqwest API is actually itself implemented using <code>block_on</code>: so Barbara would have ultimately hit the same issues. Further, not all crates offer synchronous APIs -- some offer only async APIs. In fact, these same issues are probably the sources of those panics that Barbara encountered in the past.</p>
<p>In general, though, embedded sync within async or vice versa works &quot;ok&quot;, once you know the right tricks. Where things become challenging is when you have a &quot;sandwich&quot;, with async-sync-async.</p>
<h3 id="do-people-mix-spawn_blocking-and-spawn-successfully-in-real-code"><a class="header" href="#do-people-mix-spawn_blocking-and-spawn-successfully-in-real-code">Do people mix <code>spawn_blocking</code> and <code>spawn</code> successfully in real code?</a></h3>
<p>Yes! Here is <a href="https://github.com/rust-lang/rustc-perf/blob/3651aa744ab2a22e1adf96a698851165086ad835/site/src/main.rs#L35-L36">some code from perf.rust-lang.org</a> doing exactly that. The catch is that it winds up giving you a future in the end, which didn't work for Barbara because her code is embedded within an iterator (and hence she can't make things async &quot;all the way down&quot;).</p>
<h3 id="what-are-other-ways-people-could-experience-similar-problems-mixing-sync-and-async"><a class="header" href="#what-are-other-ways-people-could-experience-similar-problems-mixing-sync-and-async">What are other ways people could experience similar problems mixing sync and async?</a></h3>
<ul>
<li>Using <code>std::Mutex</code> in async code.</li>
<li>Calling the blocking version of an asynchronous API.
<ul>
<li>For example, <code>reqwest::blocking</code>, the synchronous <a href="https://gitlab.freedesktop.org/dbus/zbus/-/blob/main/zbus/src/proxy.rs#L121"><code>zbus</code></a> and <a href="https://github.com/bytebeamio/rumqtt/blob/8de24cbc0484f459246251873aa6c80be8b6e85f/rumqttc/src/client.rs#L224"><code>rumqtt</code></a> APIs.</li>
<li>These are commonly implemented by using some variant of <code>block_on</code> internally.</li>
<li>Therefore they can lead to panics or deadlocks depending on what async runtime they are built from and used with.</li>
</ul>
</li>
</ul>
<h3 id="why-wouldnt-barbara-just-make-everything-async-from-the-start"><a class="header" href="#why-wouldnt-barbara-just-make-everything-async-from-the-start">Why wouldn't Barbara just make everything async from the start?</a></h3>
<p>There are times when converting synchronous code to async is difficult or even impossible. Here are some of the reasons:</p>
<ul>
<li><a href="./alan_needs_async_in_traits.html">Asynchronous functions cannot appear in trait impls</a>.</li>
<li>Asynchronous functions cannot be called from APIs that take closures for callbacks, like <code>Iterator::map</code> in this example.</li>
<li>Sometimes the synchronous functions come from other crates and are not fully under their control.</li>
<li>It's just a lot of work!</li>
</ul>
<h3 id="how-many-variants-of-block_on-are-there"><a class="header" href="#how-many-variants-of-block_on-are-there">How many variants of <code>block_on</code> are there?</a></h3>
<ul>
<li>the <code>futures</code> crate offers a runtime-independent block-on (which can lead to deadlocks, as in this story)</li>
<li>the <code>tokio</code> crate offers a <code>block_on</code> method (which will panic if used inside of another tokio runtime, as in this story)</li>
<li>the <a href="https://crates.io/crates/pollster"><code>pollster</code></a> crate exists just to offer <code>block_on</code></li>
<li>the <a href="https://docs.rs/futures-lite/1.11.3/futures_lite/future/fn.block_on.html"><code>futures-lite</code></a> crate offers a <code>block_on</code></li>
<li>the <a href="https://docs.rs/async-std/1.9.0/async_std/task/fn.block_on.html"><code>aysnc-std</code></a> crate offers <code>block_on</code></li>
<li>the <a href="https://docs.rs/async-std/1.9.0/async_std/task/fn.block_on.html"><code>async-io</code></a> crate offers <code>block_on</code></li>
<li>...there are probably more, but I think you get the point.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../mermaid.min.js"></script>
        <script src="../../../mermaid-init.js"></script>


    </div>
    </body>
</html>
