<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Barbara battles buffered streams - wg-async</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../welcome.html"><strong aria-hidden="true">1.</strong> 👋🏽 Welcome</a></li><li class="chapter-item "><a href="../../../CHARTER.html"><strong aria-hidden="true">2.</strong> 📜 Charter</a></li><li class="chapter-item "><a href="../../../meetings.html"><strong aria-hidden="true">3.</strong> 🤝 Meetings</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../triage.html"><strong aria-hidden="true">3.1.</strong> 🔍 Triage</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision.html"><strong aria-hidden="true">4.</strong> 🔮 The vision</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision.html"><strong aria-hidden="true">4.1.</strong> ❓How to vision</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision/owners.html"><strong aria-hidden="true">4.1.1.</strong> Owning a goal or initiative</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/stakeholders.html"><strong aria-hidden="true">4.1.2.</strong> Being a stakeholder</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/evaluations.html"><strong aria-hidden="true">4.1.3.</strong> Writing an evaluation</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">4.1.4.</strong> Authoring "Status quo" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">4.1.5.</strong> Authoring "Shiny future" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/comment.html"><strong aria-hidden="true">4.1.6.</strong> Commenting on stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/awards.html"><strong aria-hidden="true">4.1.7.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../../vision/how_it_feels.html"><strong aria-hidden="true">4.2.</strong> 🥰 How using async Rust ought to feel</a></li><li class="chapter-item "><a href="../../../vision/characters.html"><strong aria-hidden="true">4.3.</strong> 🙋‍♀️ Cast of characters</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/characters/alan.html"><strong aria-hidden="true">4.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../../vision/characters/grace.html"><strong aria-hidden="true">4.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../../vision/characters/niklaus.html"><strong aria-hidden="true">4.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../../vision/characters/barbara.html"><strong aria-hidden="true">4.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../../vision/projects.html"><strong aria-hidden="true">4.4.</strong> ⚡ Projects</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/projects/template.html"><strong aria-hidden="true">4.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">4.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../../vision/projects/DistriData.html"><strong aria-hidden="true">4.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">4.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/YouBuy.html"><strong aria-hidden="true">4.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../../vision/projects/SLOW.html"><strong aria-hidden="true">4.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item "><a href="../../../vision/status_quo.html"><strong aria-hidden="true">4.5.</strong> 😱 Status quo</a></li><li class="chapter-item "><a href="../../../vision/shiny_future.html"><strong aria-hidden="true">4.6.</strong> ✨ Shiny future</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/shiny_future/users_manual.html"><strong aria-hidden="true">4.6.1.</strong> 📚 User's manual of the future</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap.html"><strong aria-hidden="true">4.7.</strong> 📅 Roadmap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn.html"><strong aria-hidden="true">4.7.1.</strong> Async fn everywhere</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/boxable.html"><strong aria-hidden="true">4.7.1.1.</strong> Boxable async fn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/async_main_and_tests.html"><strong aria-hidden="true">4.7.1.2.</strong> Async main and tests</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes.html"><strong aria-hidden="true">4.7.2.</strong> Scoped spawn and reliable cancellation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability.html"><strong aria-hidden="true">4.7.2.1.</strong> Capability</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_async_trait.html"><strong aria-hidden="true">4.7.2.1.1.</strong> Variant: Async trait</a></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_leak.html"><strong aria-hidden="true">4.7.2.1.2.</strong> Variant: Leak trait</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/scope_api.html"><strong aria-hidden="true">4.7.2.2.</strong> Scope API</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter.html"><strong aria-hidden="true">4.7.3.</strong> Async iteration</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/traits.html"><strong aria-hidden="true">4.7.3.1.</strong> Traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/generators.html"><strong aria-hidden="true">4.7.3.2.</strong> Generators</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/portable.html"><strong aria-hidden="true">4.7.4.</strong> Portable and interoperable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/portable/read_write.html"><strong aria-hidden="true">4.7.4.1.</strong> Read/write traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/timers.html"><strong aria-hidden="true">4.7.4.2.</strong> Timers</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/spawn.html"><strong aria-hidden="true">4.7.4.3.</strong> Spawn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/runtime.html"><strong aria-hidden="true">4.7.4.4.</strong> Runtime</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/polish.html"><strong aria-hidden="true">4.7.5.</strong> Polish</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_must_not_suspend.html"><strong aria-hidden="true">4.7.5.1.</strong> must_not_suspend lint</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_blocking_fns.html"><strong aria-hidden="true">4.7.5.2.</strong> Lint blocking fns</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_large_copies.html"><strong aria-hidden="true">4.7.5.3.</strong> Lint large copies</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/error_messages.html"><strong aria-hidden="true">4.7.5.4.</strong> Error messages for the most confusing scenarios</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/stacktraces.html"><strong aria-hidden="true">4.7.5.5.</strong> Stacktraces</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/precise_generator_captures.html"><strong aria-hidden="true">4.7.5.6.</strong> Precise Generator Captures</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/sync_and_async.html"><strong aria-hidden="true">4.7.5.7.</strong> Sync and async behave the same</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/tooling.html"><strong aria-hidden="true">4.7.6.</strong> Tooling</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/tooling/crashdump.html"><strong aria-hidden="true">4.7.6.1.</strong> Crashdump</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/testing.html"><strong aria-hidden="true">4.7.7.</strong> Testing</a></li><li class="chapter-item "><a href="../../../vision/roadmap/documentation.html"><strong aria-hidden="true">4.7.8.</strong> Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/documentation/async_book.html"><strong aria-hidden="true">4.7.8.1.</strong> Async book</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/threadsafe_portability.html"><strong aria-hidden="true">4.7.9.</strong> Threadsafe portability</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_overloading.html"><strong aria-hidden="true">4.7.10.</strong> Async overloading</a></li></ol></li><li class="chapter-item "><a href="../../../vision/unresolved_questions.html"><strong aria-hidden="true">4.8.</strong> ❓ Major unresolved questions or controversies</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/unresolved_questions/default_runtime.html"><strong aria-hidden="true">4.8.1.</strong> Default runtime?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/async_fn.html"><strong aria-hidden="true">4.8.2.</strong> How to represent the AsyncFn traits?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/cancellation.html"><strong aria-hidden="true">4.8.3.</strong> How best to integrate voluntary cancellation?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/portable_without_generics.html"><strong aria-hidden="true">4.8.4.</strong> Extend stdlib to permit portable async without generics?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/await_or_not.html"><strong aria-hidden="true">4.8.5.</strong> To await or not to await?</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories.html"><strong aria-hidden="true">4.9.</strong> 💝 Appendix: Submitted stories</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo.html"><strong aria-hidden="true">4.9.1.</strong> 😱 Status quo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/template.html"><strong aria-hidden="true">4.9.1.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_task_scheduler.html"><strong aria-hidden="true">4.9.1.2.</strong> Alan builds a task scheduler</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_creates_a_hanging_alarm.html"><strong aria-hidden="true">4.9.1.3.</strong> Alan creates a hanging alarm</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">4.9.1.4.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">4.9.1.5.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">4.9.1.6.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">4.9.1.7.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">4.9.1.8.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_misses_c_sharp_async.html"><strong aria-hidden="true">4.9.1.9.</strong> Alan misses C# async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">4.9.1.10.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">4.9.1.11.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">4.9.1.12.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">4.9.1.13.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">4.9.1.14.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">4.9.1.15.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">4.9.1.16.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_processing_some_files.html"><strong aria-hidden="true">4.9.1.17.</strong> Alan tries tries processing some files</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html"><strong aria-hidden="true">4.9.1.18.</strong> Alan wants a prefetch iterator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">4.9.1.19.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">4.9.1.20.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer.html"><strong aria-hidden="true">4.9.1.21.</strong> Alan extends an AWS service</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">4.9.1.21.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">4.9.1.21.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">4.9.1.21.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">4.9.1.21.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">4.9.1.21.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">4.9.1.21.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">4.9.1.21.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html"><strong aria-hidden="true">4.9.1.21.8.</strong> Solving a deadlock</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">4.9.1.21.9.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">4.9.1.21.10.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">4.9.1.21.11.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_the_debugger.html"><strong aria-hidden="true">4.9.1.21.12.</strong> Using the debugger</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">4.9.1.21.13.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">4.9.1.21.14.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_ready_to_deploy.html"><strong aria-hidden="true">4.9.1.21.15.</strong> Getting ready to deply</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">4.9.1.21.16.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">4.9.1.22.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html"><strong aria-hidden="true">4.9.1.23.</strong> Barbara awants single threaded optimizations</a></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo/barbara_battles_buffered_streams.html" class="active"><strong aria-hidden="true">4.9.1.24.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html"><strong aria-hidden="true">4.9.1.25.</strong> Barbara begets backpressure and benchmarks async_trait</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">4.9.1.26.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">4.9.1.27.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">4.9.1.28.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">4.9.1.29.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">4.9.1.30.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">4.9.1.31.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">4.9.1.32.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">4.9.1.33.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_polls_a_mutex.html"><strong aria-hidden="true">4.9.1.34.</strong> Barbara polls a Mutex</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">4.9.1.35.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_unix_socket.html"><strong aria-hidden="true">4.9.1.36.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">4.9.1.37.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">4.9.1.38.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">4.9.1.39.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wishes_for_easy_runtime_switch.html"><strong aria-hidden="true">4.9.1.40.</strong> Barbara wishes for an easy runtim switch</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">4.9.1.41.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_debugs_a_crash_dump.html"><strong aria-hidden="true">4.9.1.42.</strong> Grace debugs a crash dump</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">4.9.1.43.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">4.9.1.44.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">4.9.1.45.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_a_zero_copy_api.html"><strong aria-hidden="true">4.9.1.46.</strong> Grace wants a zero copy API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">4.9.1.47.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">4.9.1.48.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">4.9.1.49.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">4.9.1.50.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future.html"><strong aria-hidden="true">4.9.2.</strong> ✨ Shiny future</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/template.html"><strong aria-hidden="true">4.9.2.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">4.9.2.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">4.9.2.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">4.9.2.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">4.9.2.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">4.9.2.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">4.9.2.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">4.9.2.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">4.9.2.9.</strong> Barbara wants async tracing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/grace_debugs_a_crash_dump_again.html"><strong aria-hidden="true">4.9.2.10.</strong> Grace debugs a crash dump again</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../../design_docs.html"><strong aria-hidden="true">5.</strong> 🔬 Design docs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/yield_safe.html"><strong aria-hidden="true">5.1.</strong> ⚠️ Yield-safe lint</a></li><li class="chapter-item "><a href="../../../design_docs/stream.html"><strong aria-hidden="true">5.2.</strong> ☔ Stream trait</a></li><li class="chapter-item "><a href="../../../design_docs/generator_syntax.html"><strong aria-hidden="true">5.3.</strong> ⚡ Generator syntax</a></li><li class="chapter-item "><a href="../../../design_docs/async_read_write.html"><strong aria-hidden="true">5.4.</strong> 📝 AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">5.5.</strong> 🧬 Async fn in traits</a></li><li class="chapter-item "><a href="../../../design_docs/mutex.html"><strong aria-hidden="true">5.6.</strong> 🔒 Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../../design_docs/channels.html"><strong aria-hidden="true">5.7.</strong> 📺 Async aware channels</a></li><li class="chapter-item "><a href="../../../design_docs/async_closures.html"><strong aria-hidden="true">5.8.</strong> 📦 Async closures</a></li><li class="chapter-item "><a href="../../../design_docs/join.html"><strong aria-hidden="true">5.9.</strong> 🤝 Join combinator</a></li><li class="chapter-item "><a href="../../../design_docs/select.html"><strong aria-hidden="true">5.10.</strong> 🤷‍♀️ Select combinator</a></li><li class="chapter-item "><a href="../../../design_docs/sink_trait.html"><strong aria-hidden="true">5.11.</strong> 🚰 Sink trait</a></li><li class="chapter-item "><a href="../../../design_docs/async_main.html"><strong aria-hidden="true">5.12.</strong> 🎇 Async main</a></li><li class="chapter-item "><a href="../../../design_docs/async_drop.html"><strong aria-hidden="true">5.13.</strong> 🗑️ Async drop</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/async_lifecycle.html"><strong aria-hidden="true">5.13.1.</strong> ♻️ Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../../design_docs/completion_based_futures.html"><strong aria-hidden="true">5.14.</strong> ⏳ Completion-based futures</a></li><li class="chapter-item "><a href="../../../design_docs/async_stack_traces.html"><strong aria-hidden="true">5.15.</strong> 🥞 Async Stack Traces</a></li></ol></li><li class="chapter-item "><a href="../../../conversations.html"><strong aria-hidden="true">6.</strong> 💬 Conversations</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">6.1.</strong> 🐦 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../../acknowledgments.html"><strong aria-hidden="true">7.</strong> ❤️ Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async/tree/master/src/vision/submitted_stories/status_quo/barbara_battles_buffered_streams.md?mode&#x3D;edit" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-barbara-battles-buffered-streams"><a class="header" href="#-status-quo-stories-barbara-battles-buffered-streams">😱 Status quo stories: Barbara battles buffered streams</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">🚧 Warning: Draft status 🚧</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today.</p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories <a href="../../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<h3 id="mysterious-timeouts"><a class="header" href="#mysterious-timeouts">Mysterious timeouts</a></h3>
<p>Barbara is working on her <a href="../../projects/YouBuy.html">YouBuy</a> server and is puzzling over a strange bug report. She is encountering users reporting that their browser connection is timing out when they connect to <a href="../../projects/YouBuy.html">YouBuy</a>. Based on the logs, she can see that they are timing out in the <code>do_select</code> function:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_select&lt;T&gt;(database: &amp;Database, query: Query) -&gt; Result&lt;Vec&lt;T&gt;&gt; {
    let conn = database.get_conn().await?;
    conn.select_query(query).await
}
<span class="boring">}</span></code></pre></pre>
<p>This is surprising, because <code>do_select</code> doesn't do much - it does a database query to claim a work item from a queue, but isn't expected to handle a lot of data or hit extreme slowdown on the database side.
Some of the time, there is some kind of massive delay in between the <code>get_conn</code> method opening a connection and the call to <code>select_query</code>. But why? She has metrics that show that the CPU is largely idle, so it's not like the cores are all occupied.</p>
<p>She looks at the caller of <code>do_select</code>, which is a function <code>do_work</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_work(database: &amp;Database) {
    let work = do_select(database, FIND_WORK_QUERY)?;
    stream::iter(work)
        .map(|item| do_select(database, work_from_item(item)))
        .buffered(5)
        .for_each(|work_item| process_work_item(database, work_item))
        .await;
}

async fn process_work_item(...) { }
<span class="boring">}</span></code></pre></pre>
<p>The <code>do_work</code> function is invoking <code>do_select</code> as part of a stream; it is buffering up a certain number of <code>do_select</code> instances and, for each one, invoking <code>process_work_item</code>. Everything seems to be in order, and she can see that calls to <code>process_work_item</code> are completing in the logs.</p>
<p>Following a hunch, she adds more logging in and around the <code>process_work_item</code> function and waits a few days to accumulate new logs. She notices that shortly after each time out, there is always a log of a <code>process_work_item</code> call that takes at least 20 seconds. These calls are not related to the connections that time out, they are for other connections, but they always appear afterwards in time.</p>
<p><code>process_work_item</code> is expected to be slow sometimes because it can end up handling large items, so this is not immediately surprising to Barbara. She is, however, surprised by the correlation - surely the executor ensures that <code>process_work_item</code> can't stop <code>do_select</code> from doing its job?</p>
<h3 id="barbara-thought-she-understood-how-async-worked"><a class="header" href="#barbara-thought-she-understood-how-async-worked">Barbara thought she understood how async worked</a></h3>
<p>Barbara thought she understood futures fairly well. She thought of <code>async fn</code> as basically &quot;like a synchronous function with more advanced control flow&quot;. She knew that Rust's futures were lazy -- that they didn't start executing until they were awaited -- and she knew that could compose them using utilities like <a href="https://docs.rs/futures/0.3/futures/future/fn.join.html"><code>join</code></a>, <a href="https://docs.rs/futures/0.3.14/futures/stream/struct.FuturesUnordered.html"><code>FuturesUnordered</code></a>, or the <a href="https://docs.rs/futures/0.3/futures/stream/trait.StreamExt.html#method.buffered"><code>buffered</code></a> method (as in this example).</p>
<p>Barbara also knows that every future winds up associated with a task, and that if you have multiple futures on the same task (in this case, the futures in the stream, for example) then they would run concurrently, but not in parallel. Based on this, she thinks perhaps that <code>process_work_item</code> is a CPU hog that takes too long to complete, and so she needs to add a call to <code>spawn_blocking</code>. But when she looks more closely, she realizes that <code>process_work_item</code> is an async function, and those 20 seconds that it spends executing are mostly spent waiting on I/O. Huh, that's confusing, because the task ought to be able to execute other futures in that case -- so why are her connections stalling out without making progress?</p>
<h3 id="barbara-goes-deep-into-how-poll-works"><a class="header" href="#barbara-goes-deep-into-how-poll-works">Barbara goes deep into how poll works</a></h3>
<p>She goes to read the Rust async book and tries to think about the model, but she can't quite see the problem. Then she asks on the rust-lang Discord and someone explains to her what is going on, with the catchphrase &quot;remember, <code>async</code> is about waiting in parallel, not working in parallel&quot;. Finally, after reading over what they wrote a few times, and reading some chapters in the async book, she sees the problem.</p>
<p>It turns out that, to Rust, a task is kind of a black box with a &quot;poll&quot; function. When the executor thinks a task can make progress, it calls poll. The task itself then delegates this call to poll down to all the other futures that are composed together. In the case of her buffered stream of connections, the stream gets woken up and it would then delegate down the various buffered items in its list.</p>
<p>When it executes <code>Stream::for_each</code>, the task is doing something like this:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>while let Some(work_item) = stream.next().await {
    process_work_item(database, work_item).await;
}
<span class="boring">}</span></code></pre></pre>
<p>The task can only &quot;wait&quot; on one &quot;await&quot; at a time. It will execute that await until it completes and only then move on to the rest of the function. When the task is blocked on the first <code>await</code>, it will process all the futures that are part of the stream, and hence the various buffered connections all make progress.</p>
<p>But once a work item is produced, the task will block on the <em>second</em> <code>await</code> -- the one that resulted from <code>process_work_item</code>. This means that, until <code>process_work_item</code> completes, control will <em>never return to the first <code>await</code></em>. As a result, none of the futures in the stream will make progress, even if they could do so!</p>
<h3 id="the-fix"><a class="header" href="#the-fix">The fix</a></h3>
<p>Once Barbara understands the problem, she considers the fix. The most obvious fix is to spawn out tasks for the <code>do_select</code> calls, like so:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_work(database: &amp;Database) {
    let work = do_select(database, FIND_WORK_QUERY)?;
    stream::iter(work)
        .map(|item| task::spawn(do_select(database, work_from_item(item))))
        .buffered(5)
        .for_each(|work_item| process_work_item(database, work_item))
        .await;
}
<span class="boring">}</span></code></pre></pre>
<p>Spawning a task will allow the runtime to keep moving those tasks along independently of the <code>do_work</code> task. Unfortunately, this change results in a compilation error:</p>
<pre><code>error[E0759]: `database` has an anonymous lifetime `'_` but it needs to satisfy a `'static` lifetime requirement
  --&gt; src/main.rs:8:18
   |
8  | async fn do_work(database: &amp;Database) {
   |                  ^^^^^^^^  --------- this data with an anonymous lifetime `'_`...
   |                  |
   |                  ...is captured here...
   |        .map(|item| task::spawn(do_select(database, work_from_item(item))))
   |                    ----------- ...and is required to live as long as `'static` here
</code></pre>
<p>&quot;Ah, right,&quot; she says, &quot;spawned tasks can't use borrowed data. I wish I had [rayon] or the scoped threads from [crossbeam].&quot;</p>
<p>&quot;Let me see,&quot; Barbara thinks. &quot;What else could I do?&quot; She has the idea that she doesn't have to process the work items immediately. She could buffer up the work into a <a href="https://docs.rs/futures/0.3.14/futures/stream/struct.FuturesUnordered.html"><code>FuturesUnordered</code></a> and process it after everything is ready:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_work(database: &amp;Database) {
    let work = do_select(database, FIND_WORK_QUERY)?;
    let mut results = FuturesUnordered::new();
    stream::iter(work)
        .map(|item| do_select(database, work_from_item(item)))
        .buffered(5)
        .for_each(|work_item| {
            results.push(process_work_item(database, work_item));
            futures::future::ready(())
        })
        .await;

    while let Some(_) = results.next().await { }
}
<span class="boring">}</span></code></pre></pre>
<p>This changes the behavior of her program quite a bit though. The original goal was to have at most 5 <code>do_select</code> calls occurring concurrently with exactly one <code>process_work_item</code>, but now she has all of the <code>process_work_item</code> calls executing at once. Nonetheless, the hack solves her immediate problem. Buffering up work into a <code>FuturesUnordered</code> becomes a kind of &quot;fallback&quot; for those cases where can't readily insert a <code>task::spawn</code>.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">🤔 Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<ul>
<li>Rust's future model is a 'leaky abstraction' that works quite differently from futures in other languages. It is prone to some subtle bugs that require a relatively deep understanding of its inner works to understand and fix.</li>
<li>&quot;Nested awaits&quot; -- where the task blocks on an inner await while there remains other futures that are still awaiting results -- are easy to do but can cause a lot of trouble.</li>
<li>Lack of scoped futures makes it hard to spawn items into separate tasks for independent processing sometimes.</li>
</ul>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<p>This is based on the bug report <a href="https://github.com/rust-lang/futures-rs/issues/2387">Footgun with Future Unordered</a> but the solution that Barbara came up with is something that was relayed by <a href="https://github.com/farnz">farnz</a> vision doc writing session. <a href="https://github.com/farnz">farnz</a> mentioned at the time that this pattern was frequently used in their codebase to work around this sort of hazard.</p>
<h3 id="why-did-you-choose-barbara-to-tell-this-story"><a class="header" href="#why-did-you-choose-barbara-to-tell-this-story"><strong>Why did you choose Barbara to tell this story?</strong></a></h3>
<p>To illustrate that knowing Rust -- and even having a decent handle on async Rust's basic model -- is not enough to make it clear what is going on in this particular case.</p>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<p>Woe be unto them! Identifying and fixing this bug required a lot of fluency with Rust and the async model. Alan in particular was probably relying on his understanding of async-await from other languages, which works very differently. In those languages, every async function is enqueued automatically for independent execution, so hazards like this do not arise (though this comes at a performance cost).</p>
<h3 id="besides-timeouts-for-clients-what-else-could-go-wrong"><a class="header" href="#besides-timeouts-for-clients-what-else-could-go-wrong">Besides timeouts for clients, what else could go wrong?</a></h3>
<p>The original bug report mentioned the possibility of deadlock:</p>
<blockquote>
<p>When using an async friendly semaphore (like Tokio provides), you can deadlock yourself by having the tasks that are waiting in the <code>FuturesUnordered</code> owning all the semaphores, while having an item in a <code>.for_each()</code> block after <code>buffer_unordered()</code> requiring a semaphore.</p>
</blockquote>
<h3 id="is-there-any-way-for-barbara-to-both-produce-and-process-work-items-simultaneously"><a class="header" href="#is-there-any-way-for-barbara-to-both-produce-and-process-work-items-simultaneously">Is there any way for Barbara to both produce and process work items simultaneously?</a></h3>
<p>Yes, in this case, she could've. For example, she might have written</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_work(database: &amp;Database) {
    let work = do_select(database, FIND_WORK_QUERY).await?;

    stream::iter(work)
        .map(|item| async move {
            let work_item = do_select(database, work_from_item(item)).await;
            process_work_item(database, work_item).await;
        })
        .buffered(5)
        .for_each(|()| std::future::ready(()))
        .await;
}
<span class="boring">}</span></code></pre></pre>
<p>This would however mean that she would have 5 calls to <code>process_work_item</code> executing at once. In the actual case that inspired this story, <code>process_work_item</code> can take as much as 10 GB of RAM, so having multiple concurrent calls is a problem.</p>
<h3 id="is-there-any-way-for-barbara-to-both-produce-and-process-work-items-simultaneously-without-the-buffering-and-so-forth"><a class="header" href="#is-there-any-way-for-barbara-to-both-produce-and-process-work-items-simultaneously-without-the-buffering-and-so-forth">Is there any way for Barbara to both produce and process work items simultaneously, without the buffering and so forth?</a></h3>
<p>Yes, she might use a loop with a <code>select!</code>. This would ensure that she is processing <em>both</em> the stream that produces work items and the <a href="https://docs.rs/futures/0.3.14/futures/stream/struct.FuturesUnordered.html"><code>FuturesUnordered</code></a> that consumes them:</p>
<pre><pre class="playground"><code class="language-rust edition2018"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn do_work(database: &amp;Database) {
    let work = do_select(database, FIND_WORK_QUERY).await?;

    let selects = stream::iter(work)
        .map(|item| do_select(database, work_from_item(item)))
        .buffered(5)
        .fuse();
    tokio::pin!(selects);

    let mut results = FuturesUnordered::new();

    loop {
        tokio::select! {
            Some(work_item) = selects.next() =&gt; {
                results.push(process_work_item(database, work_item));
            },
            Some(()) = results.next() =&gt; { /* do nothing */ },
            else =&gt; break,
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Note that doing so is producing code that looks quite a bit different than where she started, though. :( This also behaves very differently. There can be a queue of tens of thousands of items that <code>do_select</code> grabs from, and this code will potentially pull far too many items out of the queue, which then would have to be requeued on shutdown. The intent of the <code>buffered(5)</code> call was to grab 5 work items from the queue at most, so that other hosts could pull out work items and share the load when there's a spike.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../mermaid.min.js"></script>
        <script src="../../../mermaid-init.js"></script>


    </div>
    </body>
</html>
