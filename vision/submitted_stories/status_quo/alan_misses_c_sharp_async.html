<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Alan misses C# async - wg-async</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item "><a href="../../../CHARTER.html"><strong aria-hidden="true">2.</strong> üìú Charter</a></li><li class="chapter-item "><a href="../../../meetings.html"><strong aria-hidden="true">3.</strong> ü§ù Meetings</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../triage.html"><strong aria-hidden="true">3.1.</strong> üîç Triage</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision.html"><strong aria-hidden="true">4.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision.html"><strong aria-hidden="true">4.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/how_to_vision/owners.html"><strong aria-hidden="true">4.1.1.</strong> Owning a goal or initiative</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/stakeholders.html"><strong aria-hidden="true">4.1.2.</strong> Being a stakeholder</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/evaluations.html"><strong aria-hidden="true">4.1.3.</strong> Writing an evaluation</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">4.1.4.</strong> Authoring "Status quo" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">4.1.5.</strong> Authoring "Shiny future" stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/comment.html"><strong aria-hidden="true">4.1.6.</strong> Commenting on stories</a></li><li class="chapter-item "><a href="../../../vision/how_to_vision/awards.html"><strong aria-hidden="true">4.1.7.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../../vision/how_it_feels.html"><strong aria-hidden="true">4.2.</strong> ü•∞ How using async Rust ought to feel</a></li><li class="chapter-item "><a href="../../../vision/characters.html"><strong aria-hidden="true">4.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/characters/alan.html"><strong aria-hidden="true">4.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../../vision/characters/grace.html"><strong aria-hidden="true">4.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../../vision/characters/niklaus.html"><strong aria-hidden="true">4.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../../vision/characters/barbara.html"><strong aria-hidden="true">4.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../../vision/projects.html"><strong aria-hidden="true">4.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/projects/template.html"><strong aria-hidden="true">4.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">4.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../../vision/projects/DistriData.html"><strong aria-hidden="true">4.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">4.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../../vision/projects/YouBuy.html"><strong aria-hidden="true">4.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../../vision/projects/SLOW.html"><strong aria-hidden="true">4.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item "><a href="../../../vision/status_quo.html"><strong aria-hidden="true">4.5.</strong> üò± Status quo</a></li><li class="chapter-item "><a href="../../../vision/shiny_future.html"><strong aria-hidden="true">4.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/shiny_future/users_manual.html"><strong aria-hidden="true">4.6.1.</strong> üìö User's manual of the future</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap.html"><strong aria-hidden="true">4.7.</strong> üìÖ Roadmap</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn.html"><strong aria-hidden="true">4.7.1.</strong> Async fn everywhere</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/boxable.html"><strong aria-hidden="true">4.7.1.1.</strong> Boxable async fn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_fn/async_main_and_tests.html"><strong aria-hidden="true">4.7.1.2.</strong> Async main and tests</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes.html"><strong aria-hidden="true">4.7.2.</strong> Scoped spawn and reliable cancellation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability.html"><strong aria-hidden="true">4.7.2.1.</strong> Capability</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_async_trait.html"><strong aria-hidden="true">4.7.2.1.1.</strong> Variant: Async trait</a></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/capability/variant_leak.html"><strong aria-hidden="true">4.7.2.1.2.</strong> Variant: Leak trait</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/scopes/scope_api.html"><strong aria-hidden="true">4.7.2.2.</strong> Scope API</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter.html"><strong aria-hidden="true">4.7.3.</strong> Async iteration</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/traits.html"><strong aria-hidden="true">4.7.3.1.</strong> Traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_iter/generators.html"><strong aria-hidden="true">4.7.3.2.</strong> Generators</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/portable.html"><strong aria-hidden="true">4.7.4.</strong> Portable and interoperable</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/portable/read_write.html"><strong aria-hidden="true">4.7.4.1.</strong> Read/write traits</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/timers.html"><strong aria-hidden="true">4.7.4.2.</strong> Timers</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/spawn.html"><strong aria-hidden="true">4.7.4.3.</strong> Spawn</a></li><li class="chapter-item "><a href="../../../vision/roadmap/portable/runtime.html"><strong aria-hidden="true">4.7.4.4.</strong> Runtime</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/polish.html"><strong aria-hidden="true">4.7.5.</strong> Polish</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_must_not_suspend.html"><strong aria-hidden="true">4.7.5.1.</strong> must_not_suspend lint</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_blocking_fns.html"><strong aria-hidden="true">4.7.5.2.</strong> Lint blocking fns</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/lint_large_copies.html"><strong aria-hidden="true">4.7.5.3.</strong> Lint large copies</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/error_messages.html"><strong aria-hidden="true">4.7.5.4.</strong> Error messages for the most confusing scenarios</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/stacktraces.html"><strong aria-hidden="true">4.7.5.5.</strong> Stacktraces</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/precise_generator_captures.html"><strong aria-hidden="true">4.7.5.6.</strong> Precise Generator Captures</a></li><li class="chapter-item "><a href="../../../vision/roadmap/polish/sync_and_async.html"><strong aria-hidden="true">4.7.5.7.</strong> Sync and async behave the same</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/tooling.html"><strong aria-hidden="true">4.7.6.</strong> Tooling</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/tooling/crashdump.html"><strong aria-hidden="true">4.7.6.1.</strong> Crashdump</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/testing.html"><strong aria-hidden="true">4.7.7.</strong> Testing</a></li><li class="chapter-item "><a href="../../../vision/roadmap/documentation.html"><strong aria-hidden="true">4.7.8.</strong> Documentation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/roadmap/documentation/async_book.html"><strong aria-hidden="true">4.7.8.1.</strong> Async book</a></li></ol></li><li class="chapter-item "><a href="../../../vision/roadmap/threadsafe_portability.html"><strong aria-hidden="true">4.7.9.</strong> Threadsafe portability</a></li><li class="chapter-item "><a href="../../../vision/roadmap/async_overloading.html"><strong aria-hidden="true">4.7.10.</strong> Async overloading</a></li></ol></li><li class="chapter-item "><a href="../../../vision/unresolved_questions.html"><strong aria-hidden="true">4.8.</strong> ‚ùì Major unresolved questions or controversies</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/unresolved_questions/default_runtime.html"><strong aria-hidden="true">4.8.1.</strong> Default runtime?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/async_fn.html"><strong aria-hidden="true">4.8.2.</strong> How to represent the AsyncFn traits?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/cancellation.html"><strong aria-hidden="true">4.8.3.</strong> How best to integrate voluntary cancellation?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/portable_without_generics.html"><strong aria-hidden="true">4.8.4.</strong> Extend stdlib to permit portable async without generics?</a></li><li class="chapter-item "><a href="../../../vision/unresolved_questions/await_or_not.html"><strong aria-hidden="true">4.8.5.</strong> To await or not to await?</a></li></ol></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories.html"><strong aria-hidden="true">4.9.</strong> üíù Appendix: Submitted stories</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo.html"><strong aria-hidden="true">4.9.1.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/template.html"><strong aria-hidden="true">4.9.1.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_task_scheduler.html"><strong aria-hidden="true">4.9.1.2.</strong> Alan builds a task scheduler</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_creates_a_hanging_alarm.html"><strong aria-hidden="true">4.9.1.3.</strong> Alan creates a hanging alarm</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">4.9.1.4.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">4.9.1.5.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">4.9.1.6.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">4.9.1.7.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">4.9.1.8.</strong> Alan lost the world</a></li><li class="chapter-item expanded "><a href="../../../vision/submitted_stories/status_quo/alan_misses_c_sharp_async.html" class="active"><strong aria-hidden="true">4.9.1.9.</strong> Alan misses C# async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">4.9.1.10.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">4.9.1.11.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">4.9.1.12.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">4.9.1.13.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">4.9.1.14.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">4.9.1.15.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">4.9.1.16.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_tries_processing_some_files.html"><strong aria-hidden="true">4.9.1.17.</strong> Alan tries tries processing some files</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_wants_prefetch_iterator.html"><strong aria-hidden="true">4.9.1.18.</strong> Alan wants a prefetch iterator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">4.9.1.19.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">4.9.1.20.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer.html"><strong aria-hidden="true">4.9.1.21.</strong> Alan extends an AWS service</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">4.9.1.21.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">4.9.1.21.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">4.9.1.21.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">4.9.1.21.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">4.9.1.21.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">4.9.1.21.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">4.9.1.21.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html"><strong aria-hidden="true">4.9.1.21.8.</strong> Solving a deadlock</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">4.9.1.21.9.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">4.9.1.21.10.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">4.9.1.21.11.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_the_debugger.html"><strong aria-hidden="true">4.9.1.21.12.</strong> Using the debugger</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">4.9.1.21.13.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">4.9.1.21.14.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/getting_ready_to_deploy.html"><strong aria-hidden="true">4.9.1.21.15.</strong> Getting ready to deply</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">4.9.1.21.16.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">4.9.1.22.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html"><strong aria-hidden="true">4.9.1.23.</strong> Barbara awants single threaded optimizations</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_battles_buffered_streams.html"><strong aria-hidden="true">4.9.1.24.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html"><strong aria-hidden="true">4.9.1.25.</strong> Barbara begets backpressure and benchmarks async_trait</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">4.9.1.26.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">4.9.1.27.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">4.9.1.28.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">4.9.1.29.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">4.9.1.30.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">4.9.1.31.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">4.9.1.32.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">4.9.1.33.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_polls_a_mutex.html"><strong aria-hidden="true">4.9.1.34.</strong> Barbara polls a Mutex</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">4.9.1.35.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_tries_unix_socket.html"><strong aria-hidden="true">4.9.1.36.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">4.9.1.37.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">4.9.1.38.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">4.9.1.39.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_wishes_for_easy_runtime_switch.html"><strong aria-hidden="true">4.9.1.40.</strong> Barbara wishes for an easy runtim switch</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">4.9.1.41.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_debugs_a_crash_dump.html"><strong aria-hidden="true">4.9.1.42.</strong> Grace debugs a crash dump</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">4.9.1.43.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">4.9.1.44.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">4.9.1.45.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_a_zero_copy_api.html"><strong aria-hidden="true">4.9.1.46.</strong> Grace wants a zero copy API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">4.9.1.47.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">4.9.1.48.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">4.9.1.49.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">4.9.1.50.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future.html"><strong aria-hidden="true">4.9.2.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/template.html"><strong aria-hidden="true">4.9.2.1.</strong> Template</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">4.9.2.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">4.9.2.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">4.9.2.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">4.9.2.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">4.9.2.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">4.9.2.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">4.9.2.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">4.9.2.9.</strong> Barbara wants async tracing</a></li><li class="chapter-item "><a href="../../../vision/submitted_stories/shiny_future/grace_debugs_a_crash_dump_again.html"><strong aria-hidden="true">4.9.2.10.</strong> Grace debugs a crash dump again</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../../design_docs.html"><strong aria-hidden="true">5.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/yield_safe.html"><strong aria-hidden="true">5.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../../design_docs/stream.html"><strong aria-hidden="true">5.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../../design_docs/generator_syntax.html"><strong aria-hidden="true">5.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../../design_docs/async_read_write.html"><strong aria-hidden="true">5.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">5.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../../design_docs/mutex.html"><strong aria-hidden="true">5.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../../design_docs/channels.html"><strong aria-hidden="true">5.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../../design_docs/async_closures.html"><strong aria-hidden="true">5.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../../design_docs/join.html"><strong aria-hidden="true">5.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../../design_docs/select.html"><strong aria-hidden="true">5.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../../design_docs/sink_trait.html"><strong aria-hidden="true">5.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../../design_docs/async_main.html"><strong aria-hidden="true">5.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../../design_docs/async_drop.html"><strong aria-hidden="true">5.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../design_docs/async_lifecycle.html"><strong aria-hidden="true">5.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../../design_docs/completion_based_futures.html"><strong aria-hidden="true">5.14.</strong> ‚è≥ Completion-based futures</a></li><li class="chapter-item "><a href="../../../design_docs/async_stack_traces.html"><strong aria-hidden="true">5.15.</strong> ü•û Async Stack Traces</a></li></ol></li><li class="chapter-item "><a href="../../../conversations.html"><strong aria-hidden="true">6.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">6.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../../acknowledgments.html"><strong aria-hidden="true">7.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async/tree/master/src/vision/submitted_stories/status_quo/alan_misses_c_sharp_async.md?mode&#x3D;edit" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-alan-misses-c-async"><a class="header" href="#-status-quo-stories-alan-misses-c-async">üò± Status quo stories: Alan misses C# async</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async
Rust programmers face today. </p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR
making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories
<a href="../../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to
<a href="../../how_to_vision/status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<h3 id="first-attempt"><a class="header" href="#first-attempt">First attempt</a></h3>
<p><a href="../../characters/alan.html">Alan</a> has finally gotten comfortable working in rust and finally decides to try writing async code.
He's used C#'s async and mostly loved the experience, so he decides to try writing it the same way:</p>
<pre><pre class="playground"><code class="language-rust edition2018">async fn run_async() {
    println!(&quot;Hello async!&quot;);
}

fn main() {
    run_async();
}</code></pre></pre>
<p>But the compiler didn't like this:</p>
<pre><code>warning: unused implementer of `Future` that must be used
 --&gt; src/main.rs:6:5
  |
6 |     run_async();
  |     ^^^^^^^^^^^^
  |
  = note: `#[warn(unused_must_use)]` on by default
  = note: futures do nothing unless you `.await` or poll them
</code></pre>
<p>Alan has no idea what <code>Future</code> is; he's never seen this before and it's not in his code. He sees the
note in the warning and adds <code>.await</code> to the line in <code>main</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">fn main() {
    run_async().await;
}</code></pre></pre>
<p>The compiler does't like this either.</p>
<pre><code>error[E0728]: `await` is only allowed inside `async` functions and blocks
 --&gt; src/main.rs:6:5
  |
5 | fn main() {
  |    ---- this is not `async`
6 |     run_async().await;
  |     ^^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks
</code></pre>
<p>... so Alan adds <code>async</code> to <code>main</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">async fn main() {
    run_async().await;
}</code></pre></pre>
<p>which prompts yet another error from the compiler:</p>
<pre><code>error[E0277]: `main` has invalid return type `impl Future`
 --&gt; src/main.rs:5:17
  |
5 | async fn main() {
  |                 ^ `main` can only return types that implement `Termination`
  |
  = help: consider using `()`, or a `Result`

error[E0752]: `main` function is not allowed to be `async`
 --&gt; src/main.rs:5:1
  |
5 | async fn main() {
  | ^^^^^^^^^^^^^^^ `main` function is not allowed to be `async`
</code></pre>
<p>So Alan decides to do a lot of research online and hunting around on StackOverflow. He learns that
<code>async fn</code> returns a value, but it's not the same as the value returned from async functions in C#.
In C#, the object he gets back can only be used to query the result of an already running thread of
work. The rust one doesn't seem to do anything until you call <code>.await</code> on it. Alan thinks this is
really nice because he now has more control over when the processing starts. You seem to get the same
control as constructing a <code>Task</code> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task?view=net-5.0#task-instantiation">manually</a> in C#, but with a lot less effort.</p>
<p>He also ends up finding out a little about executors. <code>tokio</code> seems to be really popular, so he
incorporates that into his project:</p>
<pre><pre class="playground"><code class="language-rust edition2018">async fn run_async() {
    println!(&quot;Hello async!&quot;);
}

#[tokio::main]
async fn main() {
    run_async().await;
}</code></pre></pre>
<p>And it works!</p>
<pre><code>Hello async!
</code></pre>
<h3 id="attempting-concurrency"><a class="header" href="#attempting-concurrency">Attempting concurrency</a></h3>
<p>Alan decides to try running two async functions concurrently. &quot;This is pretty easy in C#,&quot; he
thinks, &quot;This can't be too hard in rust.&quot;</p>
<p>In C# Alan would usually write something like:</p>
<pre><code class="language-csharp">async Task expensive1() {
    ...
}

async Task expensive2() {
    ...
}

public static async Main() {
    Task task = expensive1();
    await expensive2();
    task.Wait();
}
</code></pre>
<p>If the code was more dynamic, Alan could have also used the Task API to simplify the await:</p>
<pre><code class="language-csharp">public static Main() {
    List&lt;Task&gt; tasks = new List&lt;Task&gt;();
    tasks.push(expensive1());
    tasks.push(expensive2());
    try {
        Task.WaitAll(tasks.ToArray());
    }
    // Ignore exceptions here.
    catch (AggregateException) {}
}
</code></pre>
<p>So Alan tries the first approach in rust:</p>
<pre><pre class="playground"><code class="language-rust edition2018">use std::sync::mpsc::{self, Sender, Receiver};

async fn expensive1(tx: Sender&lt;()&gt;, rx: Receiver&lt;()&gt;) {
    println!(&quot;Doing expensive work in 1&quot;);
    tx.send(()).ok();
    let _ = rx.recv();
    println!(&quot;Got result, finishing processing in 1&quot;);
    println!(&quot;1 done&quot;);
}

async fn expensive2(tx: Sender&lt;()&gt;, rx: Receiver&lt;()&gt;) {
    println!(&quot;Doing simple setup in 2&quot;);
    let _ = rx.recv();
    println!(&quot;Got signal from 1, doing expensive processing in 2&quot;);
    tx.send(()).ok();
    println!(&quot;2 done&quot;);
}

#[tokio::main]
async fn main() {
    let (tx1, rx1) = mpsc::channel();
    let (tx2, rx2) = mpsc::channel();
    expensive1(tx1, rx2).await;
    expensive2(tx2, rx1).await;
}</code></pre></pre>
<p>But this just hangs after printing:</p>
<pre><code>Doing expensive work in 1
</code></pre>
<p>Alan wonders if this means he can't run code concurrently... he does some research and learns about
<code>join</code>, which doesn't seem to be part of the std. This seems like the second example in C#, but Alan
is surprised it doesn't come with the standard library. He has to import <code>futures</code> as a dependency
and tries again:</p>
<pre><pre class="playground"><code class="language-rust edition2018">use futures::join;
...

#[tokio::main]
async fn main() {
    let (tx1, rx1) = mpsc::channel();
    let (tx2, rx2) = mpsc::channel();
    let fut1 = expensive1(tx1, rx2);
    let fut2 = expensive2(tx2, rx1);
    join!(fut1, fut2);
}</code></pre></pre>
<p>But this still hangs the same way as the first attempt. After more research, Alan learns that he
can't use the standard <code>mpsc::channel</code> in async contexts. He needs to use the ones in the external
<code>futures</code> crate. This requires quite a few changes since the API's don't line up with the one's in
std:</p>
<ul>
<li><code>rx</code> has to be <code>mut</code></li>
<li>there's bounded and unbounded mpsc channels, Alan went with unbounded since the API seemed simpler
for now</li>
<li>you need to import the <code>StreamExt</code> trait to be able to get a value out of <code>rx</code>, this took a lot of
research to get right.</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2018">use futures::{
    join,
    channel::mpsc::{self, UnoundedSender, UnboundedReceiver},
    StreamExt,
};
use std::sync::mpsc::{self, Sender, Receiver};

async fn expensive1(tx: Sender&lt;()&gt;, mut rx: Receiver&lt;()&gt;) {
    println!(&quot;Doing expensive work in 1&quot;);
    tx.unbounded_send(()).ok();
    let _ = rx.next().await;
    println!(&quot;Got result, finishing processing in 1&quot;);
    println!(&quot;1 done&quot;);
}

async fn expensive2(tx: Sender&lt;()&gt;, mut rx: Receiver&lt;()&gt;) {
    println!(&quot;Doing simple setup in 2&quot;);
    let _ = rx.next().await;
    println!(&quot;Got signal from 1, doing expensive processing in 2&quot;);
    tx.unbounded_send(()).ok();
    println!(&quot;2 done&quot;);
}

#[tokio::main]
async fn main() {
    let (tx1, rx1) = mpsc::channel();
    let (tx2, rx2) = mpsc::channel();
    let fut1 = expensive1(tx1, rx2);
    let fut2 = expensive2(tx2, rx1);
    join!(fut1, fut2);
}</code></pre></pre>
<p>And now it works!</p>
<pre><code>Doing expensive work in 1
Doing simple setup in 2
Got signal from 1, doing expensive processing in 2
2 done
Got result, finishing processing in 1
1 done
</code></pre>
<p>While this is more similar to using the <code>Task.WaitAll</code> from C#, there were a lot more changes needed
than Alan expected.</p>
<h3 id="cancelling-tasks"><a class="header" href="#cancelling-tasks">Cancelling tasks</a></h3>
<p>Another pattern Alan had to use frequently in C# was accounting for cancellation of tasks. Users in
GUI applications might not want to wait for some long running operation or in a web server some
remote calls might time out. C# has a really nice API surrounding <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken?view=net-5.0"><code>CancellationTokens</code></a>.</p>
<p>They can be used in a fashion similar to (overly simplified example):</p>
<pre><code class="language-csharp">async Task ExpensiveWork(CancellationToken token) {
    while (not_done) {
        // Do expensive operations...
        if (token.IsCancellationRequested) {
            // Cleanup...
            break;
        }
    }
}

public static async Main() {
    // Create the cancellation source and grab its token.
    CancellationTokenSource source = new CancellationTokenSource();
    CancellationToken token = source.Token;

    // Setup a handler so that on user input the expensive work will be canceled.
    SetupInputHandler(() =&gt; {
        // on user cancel
        source.Cancel();
    });

    // Pass the token to the functions that should be stopped when requested.
    await ExpensiveWork(token);
}
</code></pre>
<p>Alan does some research. He searches for &quot;rust async cancellation&quot; and can't find anything similar.
He reads that &quot;dropping a future is cancelling it&quot;. In his junior dev days, Alan might have run with
that idea and moved on to the next task, but experienced Alan knows something is wrong here. If he
drops a <code>Future</code> how does he control the cleanup? Which <code>await</code> point is the one that will not be
processed? This scares Alan since he realized he could get some really nasty bugs if this happens
in production. In order to work around this, Alan needs to make sure <em>every</em> future around critical
code is carefully reviewed for drops in the wrong places. Alan also decided he needs to come up with
some custom code to handle cancelling.</p>
<p>Alan decides to ask around, and gets suggestions for searching with &quot;rust cancel future&quot; or
&quot;rust cancel async&quot;. He finds out about tokio's <a href="https://docs.rs/tokio-util/0.6.7/tokio_util/sync/struct.CancellationToken.html"><code>tokio_util::sync::CancellationToken</code></a>, and also
the <a href="https://docs.rs/stop-token/0.2.0/stop_token/"><code>stop-token</code></a> and <a href="https://docs.rs/stopper/0.2.0/stopper/"><code>stopper</code></a> crates. He decides to try working with the version in
<code>tokio_util</code> since he's already using <code>tokio</code>. Looking at the docs for each, they all seem to
behave how Alan expected, though he couldn't use <code>stop-token</code> since that only works with
<code>async-std</code>. <code>stopper</code> also seems like a good alternative, but he decides to go with the type that
is built by the tokio team.</p>
<p>Reading the docs it seems that the tokio <code>CancellationToken</code> acts more like a combination of C#'s
<code>CancellationTokenSource</code> and <code>CancellationToken</code>. He needs to pass the tokens generated from a call
to <code>child_token()</code> and keep the main token for triggering cancellation. One advantage that all of
the token crates seem to have is that they can also integrate directly with streams and futures,
or be polled directly (as a stream or boolean).</p>
<pre><pre class="playground"><code class="language-rust edition2018">use tokio_util::sync::CancellationToken;
use futures::StreamExt;
// ...

fn generate_work() -&gt; impl Stream&lt;Item = Work&gt; {
    // ...
}

async fn expensive_work(token: CancellationToken) {
    let mut work_stream = generate_work();
    loop {
        if let Some(op) = work_stream.next().await {
            op.work().await;
        } else {
            break;
        }

        if token.is_cancelled() {
            break;
        }
    }
}

#[tokio::main]
async fn main() {
    let token = CancellationToken::new();
    let child_token = token.child_token();
    setup_input_handler(move || {
        token.cancel();
    });

    expensive_work(child_token).await;
}</code></pre></pre>
<p>This seems relatively straightforward!</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<ul>
<li>First Attempt
<ul>
<li>Unused implementer warnings for <code>Futures</code> are less clear than they are for, e.g. <code>Result</code>.</li>
<li>It's not as easy to jump into experimenting with async as compared to synchronous code. It
requires a lot more front-end research on the user's end.</li>
<li>Developers might need to unlearn async behavior from other languages in order to understand
async rust.</li>
<li>Dynamic languages with async provide async main, but rust does not. We could be more helpful
by explaining this in compiler errors.</li>
</ul>
</li>
<li>Attempting Concurrency
<ul>
<li>Trying to use items from std is the obvious thing to try, but wrong because they are blocking.</li>
<li>The corresponding async versions of the std items don't exist in std, but are in <code>futures</code>
crate. So it's hard to actually develop in async without the <code>futures</code> crates.</li>
</ul>
</li>
<li>Cancelling Tasks
<ul>
<li>It's not obvious that futures could only run part-way.</li>
<li>Async types and crates can be bound to certain ecosystems, limiting developers' ability to
reuse existing code.</li>
</ul>
</li>
</ul>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<ul>
<li>The docs for <a href="https://docs.rs/futures/0.3.15/futures/channel/oneshot/struct.Canceled.html"><code>oneshot::Canceled</code></a> mentions that dropping a <code>Sender</code> will cancel the future.
Someone inexperienced might accidentally apply this to a broader scope of types.</li>
<li><a href="https://internals.rust-lang.org/t/async-await-the-challenges-besides-syntax-cancellation/10287">This IRLO post</a> has a nice discussion on cancellation, where the <a href="https://gist.github.com/Matthias247/ffc0f189742abf6aa41a226fe07398a8">linked gist</a>
is a thorough overview of problems surrounding cancelation in async rust, with comparisons to other
languages.</li>
</ul>
<h3 id="why-did-you-choose-alan-to-tell-this-story"><a class="header" href="#why-did-you-choose-alan-to-tell-this-story"><strong>Why did you choose Alan to tell this story?</strong></a></h3>
<p>C# is a garbage collected language that has had async for a long time. Alan best fit the model for
a developer coming from such a language.</p>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<ul>
<li><a href="../../characters/barbara.html">Barbara</a> may already be used to the ideosynchracies of async in rust. She may not realize how
difficult it could be for someone who has a very different model of async engrained into them.</li>
<li><a href="../../characters/grace.html">Grace</a> has likely never used async utilities similar to the ones in C# and other GC languages. C
and C++ tend to use callbacks to manage async workflows. She may have been following the C++
proposals for coroutines (e.g. <code>co_await</code>, <code>co_yield</code>, <code>co_return</code>), but similar to rust, the
utilities are not yet thoroughly built out in those spaces. She may be familiar with cancelation in
external libraries like <a href="https://github.com/lewissbaker/cppcoro#Cancellation"><code>cppcoro</code></a>, or async in
general with <a href="https://github.com/Naios/continuable"><code>continuable</code></a></li>
<li><a href="../../characters/niklaus.html">Niklaus</a> may not have had enough experience to be wary of some of the pitfalls encountered here.
He might have introduced bugs around dropping futures (to cancel) without realizing it.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../vision/submitted_stories/status_quo/alan_lost_the_world.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../vision/submitted_stories/status_quo/alan_lost_the_world.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../mermaid.min.js"></script>
        <script src="../../../mermaid-init.js"></script>


    </div>
    </body>
</html>
